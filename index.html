<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>VoiceMD - Voice Data Entry</title>
  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 10px;
      background: #f5f5f5;
      font-size: 14px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 20px;
      text-align: center;
    }

    .header h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    .home-content {
      padding: 20px;
    }

    .watermark {
      text-align: center;
      padding: 20px;
      color: #9ca3af;
      font-size: 13px;
      font-style: italic;
      border-top: 1px solid #e5e7eb;
      margin-top: 20px;
    }

    .trial-list {
      margin-top: 20px;
    }

    .trial-item {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .trial-info h3 {
      margin: 0 0 5px 0;
      font-size: 16px;
      color: #111827;
    }

    .trial-info p {
      margin: 0;
      font-size: 13px;
      color: #6b7280;
    }

    .trial-actions {
      display: flex;
      gap: 10px;
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 600;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-open {
      background: #667eea;
      color: white;
    }

    .btn-delete {
      background: #ef4444;
      color: white;
    }

    .controls {
      padding: 15px;
      background: #fafafa;
      border-bottom: 1px solid #e0e0e0;
    }

    .control-group {
      margin-bottom: 15px;
    }

    .control-group:last-child {
      margin-bottom: 0;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
      font-size: 13px;
    }

    input[type="number"],
    input[type="text"] {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    input:focus {
      outline: none;
      border-color: #667eea;
    }

    button {
      width: 100%;
      padding: 14px;
      font-size: 15px;
      font-weight: 600;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
      touch-action: manipulation;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:active {
      transform: scale(0.98);
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-secondary {
      background: #6b7280;
      color: white;
    }

    .mode-btn {
      background: #e5e7eb;
      color: #374151;
      padding: 12px;
      font-size: 14px;
    }

    .mode-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .search-container {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .search-container input {
      flex: 1;
      margin-bottom: 0;
    }

    .search-container button {
      width: auto;
      padding: 12px 20px;
      flex-shrink: 0;
    }

    .table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      padding: 15px;
      scroll-behavior: smooth;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      max-width: 600px;
      margin: 0 auto;
    }

    th, td {
      padding: 10px;
      text-align: center;
      border: 1px solid #e0e0e0;
      width: auto;
    }

    th {
      background: #f3f4f6;
      font-weight: 600;
      color: #374151;
      position: sticky;
      top: 0;
      z-index: 10;
      font-size: 13px;
    }

    td[contenteditable="true"] {
      background: #fefce8;
      cursor: text;
      transition: background-color 0.3s;
    }

    td[contenteditable="true"]:focus {
      outline: 2px solid #667eea;
      background: #fff;
    }

    .highlight {
      background: #dbeafe !important;
      outline: 3px solid #3b82f6 !important;
      animation: pulse 1s infinite;
    }

    .search-highlight {
      background: #fef3c7 !important;
      outline: 2px solid #f59e0b !important;
    }

    /* PLOT COLOR CLASSES */
    .plot-color-0 { background: #dbeafe !important; }
    .plot-color-1 { background: #dcfce7 !important; }
    .plot-color-2 { background: #fef3c7 !important; }
    .plot-color-3 { background: #fce7f3 !important; }
    .plot-color-4 { background: #e0e7ff !important; }
    .plot-color-5 { background: #fef2f2 !important; }
    .plot-color-6 { background: #f0fdfa !important; }
    .plot-color-7 { background: #fdf4ff !important; }
    .plot-color-8 { background: #fffbeb !important; }
    .plot-color-9 { background: #f5f3ff !important; }

    @keyframes pulse {
      0%, 100% { outline-color: #3b82f6; }
      50% { outline-color: #60a5fa; }
    }

    .status {
      padding: 15px;
      background: #f9fafb;
      border-top: 1px solid #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
    }

    #voiceStatus {
      font-weight: 500;
      color: #374151;
      font-size: 14px;
    }

    .recording {
      color: #ef4444;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0%, 50%, 100% { opacity: 1; }
      25%, 75% { opacity: 0.5; }
    }

    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 1000;
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    .nav-buttons {
      padding: 15px;
      background: #fafafa;
      border-top: 1px solid #e0e0e0;
      display: flex;
      gap: 10px;
    }

    .nav-buttons button {
      flex: 1;
    }

    .floating-btn {
      position: fixed;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      color: white;
      border: none;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
      transition: all 0.3s;
    }

    .floating-btn.show {
      display: flex;
    }

    .floating-btn:active {
      transform: scale(0.95);
    }

    .scroll-top-btn {
      bottom: 80px;
      right: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .voice-float-btn {
      bottom: 140px;
      right: 20px;
      background: #10b981;
    }

    .voice-float-btn.recording {
      background: #ef4444;
      animation: pulse-btn 1s infinite;
    }

    @keyframes pulse-btn {
      0%, 100% { box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4); }
      50% { box-shadow: 0 4px 20px rgba(239, 68, 68, 0.7); }
    }

    @media (max-width: 768px) {
      body {
        padding: 5px;
      }

      .header h1 {
        font-size: 18px;
      }

      .controls {
        padding: 12px;
      }

      th, td {
        padding: 8px;
        font-size: 13px;
      }

      table {
        max-width: 100%;
      }

      .floating-btn {
        width: 45px;
        height: 45px;
        font-size: 20px;
      }

      .scroll-top-btn {
        bottom: 70px;
        right: 15px;
      }

      .voice-float-btn {
        bottom: 125px;
        right: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üé§ VoiceMD</h1>
    </div>

    <!-- HOME PAGE -->
    <div id="homePage" class="page active">
      <div class="home-content">
        <button class="btn-primary" onclick="startNewTrial()">
          ‚ûï Start New Trial
        </button>

        <div class="trial-list">
          <h2 style="margin: 0 0 15px 0; font-size: 18px;">Previous Trials</h2>
          <div id="trialListContainer">
            <!-- Trials will be loaded here -->
          </div>
        </div>

        <div class="watermark">
          By Mr Sa
        </div>
      </div>
    </div>

    <!-- SETUP PAGE -->
    <div id="setupPage" class="page">
      <div class="controls">
        <div class="control-group">
          <label>Trial Name:</label>
          <input type="text" id="trialName" placeholder="e.g., Winter Wheat 2024">
        </div>

        <div class="control-group">
          <label>Number of Treatments:</label>
          <input type="number" id="numTreatments" value="3" min="1" max="100">
        </div>

        <div class="control-group">
          <label>Number of Reps:</label>
          <input type="number" id="numReps" value="3" min="1" max="100">
        </div>

        <div class="control-group">
          <label>Number of Subplots per Plot:</label>
          <input type="number" id="numSubplots" value="2" min="1" max="100">
        </div>

        <div class="control-group">
          <label>Custom Column Names (comma-separated):</label>
          <input type="text" id="columnNames" value="" placeholder="e.g., Height, Width, Yield">
        </div>

        <div class="control-group">
          <button class="btn-primary" onclick="generateTable()">üìä Generate Table</button>
        </div>
      </div>

      <div class="nav-buttons">
        <button class="btn-secondary" onclick="showPage('homePage')">
          ‚¨ÖÔ∏è Back
        </button>
      </div>
    </div>

    <!-- DATA ENTRY PAGE -->
    <div id="dataEntryPage" class="page">
      <div class="controls">
        <div class="control-group">
          <button class="btn-secondary" onclick="saveAndExit()">
            üíæ Save & Exit
          </button>
        </div>

        <div class="control-group">
          <label>üîç Search Plot:</label>
          <div class="search-container">
            <input type="number" id="searchPlot" placeholder="Enter plot number (e.g., 201)">
            <button class="btn-primary" onclick="searchPlot()">Search</button>
          </div>
        </div>

        <div class="control-group">
          <label>Voice Input Mode:</label>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="mode-btn" data-mode="one" style="flex: 1; min-width: 120px;">
              üìù One-at-a-Time
            </button>
            <button class="mode-btn active" data-mode="batch" style="flex: 1; min-width: 120px;">
              üìä Batch Mode
            </button>
            <button id="directionToggle" class="mode-btn" style="flex: 1; min-width: 120px;">
              ‚û°Ô∏è Horizontal
            </button>
          </div>
        </div>

        <div class="control-group">
          <button id="voiceBtn" class="btn-success" onclick="toggleVoiceRecording()">
            üé§ Start Voice Input
          </button>
        </div>

        <div class="control-group">
          <button class="btn-secondary" onclick="exportToCSV()">
            üíæ Export to CSV
          </button>
        </div>
      </div>

      <div class="table-container" id="tableContainer">
        <table id="dataTable"></table>
      </div>

      <div class="status">
        <span id="voiceStatus">Ready to start</span>
      </div>

      <div class="nav-buttons">
        <button class="btn-secondary" onclick="saveAndExit()">
          üíæ Save & Exit
        </button>
      </div>
    </div>
  </div>

  <!-- Floating Buttons -->
  <button class="floating-btn scroll-top-btn" id="scrollTopBtn" onclick="scrollToTop()">
    ‚¨ÜÔ∏è
  </button>
  <button class="floating-btn voice-float-btn" id="voiceFloatBtn" onclick="toggleVoiceRecording()">
    üé§
  </button>

<script>
// Global variables
let currentCell = null;
let isRecording = false;
let recognition = null;
let batchMode = true;
let navigationDirection = 'horizontal';
let currentTrial = null;
let currentTrialIndex = -1;
let currentPlotNumber = null;

// Audio context for beep
const audioContext = new (window.AudioContext || window.webkitAudioContext)();

// Play beep sound
function playBeep() {
  try {
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = 800;
    oscillator.type = 'sine';
    
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.1);
  } catch (e) {
    console.log('Audio not available');
  }
}

// Show toast notification
function showToast(message) {
  const existingToast = document.querySelector('.toast');
  if (existingToast) {
    existingToast.remove();
  }
  
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => toast.remove(), 2000);
}

// Show specific page
function showPage(pageId) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(pageId).classList.add('active');
  
  const voiceFloatBtn = document.getElementById('voiceFloatBtn');
  const scrollTopBtn = document.getElementById('scrollTopBtn');
  
  if (pageId === 'dataEntryPage') {
    setTimeout(() => {
      if (document.querySelector('#dataTable tbody tr')) {
        voiceFloatBtn.classList.add('show');
      }
    }, 100);
  } else {
    voiceFloatBtn.classList.remove('show');
    scrollTopBtn.classList.remove('show');
  }
}

// Start new trial
function startNewTrial() {
  currentTrialIndex = -1;
  currentTrial = null;
  document.getElementById('trialName').value = '';
  document.getElementById('numTreatments').value = '3';
  document.getElementById('numReps').value = '3';
  document.getElementById('numSubplots').value = '2';
  document.getElementById('columnNames').value = '';
  showPage('setupPage');
}

// Load trial list
function loadTrialList() {
  const trials = JSON.parse(localStorage.getItem('trials') || '[]');
  const container = document.getElementById('trialListContainer');
  
  if (trials.length === 0) {
    container.innerHTML = '<p style="color: #6b7280; text-align: center;">No trials yet. Start your first trial!</p>';
    return;
  }
  
  container.innerHTML = trials.map((trial, index) => `
    <div class="trial-item">
      <div class="trial-info">
        <h3>${trial.name || `Trial ${index + 1}`}</h3>
        <p>Treatments: ${trial.treatments} | Reps: ${trial.reps} | Subplots: ${trial.subplots}</p>
        <p style="font-size: 12px; color: #9ca3af;">${new Date(trial.date).toLocaleDateString()}</p>
      </div>
      <div class="trial-actions">
        <button class="btn-small btn-open" onclick="openTrial(${index})">Open</button>
        <button class="btn-small btn-delete" onclick="deleteTrial(${index})">Delete</button>
      </div>
    </div>
  `).join('');
}

// Open existing trial
function openTrial(index) {
  const trials = JSON.parse(localStorage.getItem('trials') || '[]');
  currentTrial = trials[index];
  currentTrialIndex = index;
  
  document.getElementById('trialName').value = currentTrial.name;
  document.getElementById('numTreatments').value = currentTrial.treatments;
  document.getElementById('numReps').value = currentTrial.reps;
  document.getElementById('numSubplots').value = currentTrial.subplots;
  document.getElementById('columnNames').value = currentTrial.columns.join(', ');
  
  generateTable();
  
  setTimeout(() => {
    loadTrialData(currentTrial.data);
  }, 100);
  
  showPage('dataEntryPage');
  showToast('‚úÖ Trial loaded');
}

// Delete trial
function deleteTrial(index) {
  if (!confirm('Delete this trial?')) return;
  
  const trials = JSON.parse(localStorage.getItem('trials') || '[]');
  trials.splice(index, 1);
  localStorage.setItem('trials', JSON.stringify(trials));
  loadTrialList();
  showToast('üóëÔ∏è Trial deleted');
}

// Get color class for plot number
function getPlotColorClass(plotNumber) {
  // Use plot number to determine color (10 different colors)
  const colorIndex = plotNumber % 10;
  return `plot-color-${colorIndex}`;
}

// Generate table with rep-based plot numbering and COLOR CODING
function generateTable() {
  const trialName = document.getElementById('trialName').value || 'Unnamed Trial';
  const numTreatments = parseInt(document.getElementById('numTreatments').value);
  const numReps = parseInt(document.getElementById('numReps').value);
  const numSubplots = parseInt(document.getElementById('numSubplots').value);
  const columnNames = document.getElementById('columnNames').value.split(',').map(c => c.trim()).filter(c => c);
  
  if (numTreatments < 1 || numReps < 1 || numSubplots < 1 || columnNames.length === 0) {
    showToast('‚ö†Ô∏è Please fill all fields correctly');
    return;
  }
  
  const table = document.getElementById('dataTable');
  table.innerHTML = '';
  
  const thead = table.createTHead();
  const headerRow = thead.insertRow();
  headerRow.insertCell().outerHTML = '<th>Plot</th>';
  headerRow.insertCell().outerHTML = '<th>Subplot</th>';
  columnNames.forEach(name => {
    headerRow.insertCell().outerHTML = `<th>${name}</th>`;
  });
  
  const tbody = table.createTBody();
  
  for (let rep = 1; rep <= numReps; rep++) {
    for (let trt = 1; trt <= numTreatments; trt++) {
      const plotNumber = (rep * 100) + trt;
      const colorClass = getPlotColorClass(plotNumber);
      
      for (let subplot = 1; subplot <= numSubplots; subplot++) {
        const row = tbody.insertRow();
        
        // PLOT CELL WITH COLOR
        const plotCell = row.insertCell();
        plotCell.textContent = plotNumber;
        plotCell.className = colorClass;
        
        // SUBPLOT CELL WITH SAME COLOR
        const subplotCell = row.insertCell();
        subplotCell.textContent = subplot;
        subplotCell.className = colorClass;
        
        columnNames.forEach(() => {
          const cell = row.insertCell();
          cell.contentEditable = 'true';
          cell.textContent = '';
          
          cell.addEventListener('focus', function() {
            currentCell = this;
            highlightCell(this);
          });
          
          cell.addEventListener('blur', function() {
            saveTrialData();
          });
          
          cell.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
              e.preventDefault();
              const nextCell = getNextEditableCell(this);
              if (nextCell) {
                nextCell.focus();
              }
            }
          });
        });
      }
    }
  }
  
  if (!currentTrial) {
    currentTrial = {
      name: trialName,
      treatments: numTreatments,
      reps: numReps,
      subplots: numSubplots,
      columns: columnNames,
      date: new Date().toISOString(),
      data: []
    };
  } else {
    currentTrial.name = trialName;
    currentTrial.treatments = numTreatments;
    currentTrial.reps = numReps;
    currentTrial.subplots = numSubplots;
    currentTrial.columns = columnNames;
  }
  
  showPage('dataEntryPage');
  showToast('‚úÖ Table generated successfully');
}

// Search plot function
function searchPlot() {
  const plotNumber = parseInt(document.getElementById('searchPlot').value);
  
  if (!plotNumber) {
    showToast('‚ö†Ô∏è Please enter a plot number');
    return;
  }
  
  document.querySelectorAll('.search-highlight').forEach(cell => {
    cell.classList.remove('search-highlight');
  });
  
  const rows = document.querySelectorAll('#dataTable tbody tr');
  let found = false;
  
  for (let row of rows) {
    const plotCell = row.cells[0];
    if (parseInt(plotCell.textContent) === plotNumber) {
      for (let i = 0; i < row.cells.length; i++) {
        row.cells[i].classList.add('search-highlight');
      }
      
      row.scrollIntoView({ behavior: 'smooth', block: 'center' });
      
      const firstEditableCell = row.querySelector('td[contenteditable="true"]');
      if (firstEditableCell) {
        setTimeout(() => {
          firstEditableCell.focus();
          currentCell = firstEditableCell;
        }, 500);
      }
      
      found = true;
      showToast(`‚úÖ Plot ${plotNumber} found`);
      break;
    }
  }
  
  if (!found) {
    showToast(`‚ùå Plot ${plotNumber} not found`);
  }
}

// Scroll to top function
function scrollToTop() {
  const tableContainer = document.getElementById('tableContainer');
  tableContainer.scrollTo({ top: 0, behavior: 'smooth' });
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Show/hide floating buttons
window.addEventListener('scroll', function() {
  const scrollBtn = document.getElementById('scrollTopBtn');
  const activePage = document.querySelector('.page.active');
  
  if (activePage && activePage.id === 'dataEntryPage') {
    if (window.pageYOffset > 300) {
      scrollBtn.classList.add('show');
    } else {
      scrollBtn.classList.remove('show');
    }
  }
});

document.addEventListener('DOMContentLoaded', function() {
  const tableContainer = document.getElementById('tableContainer');
  if (tableContainer) {
    tableContainer.addEventListener('scroll', function() {
      const scrollBtn = document.getElementById('scrollTopBtn');
      const activePage = document.querySelector('.page.active');
      
      if (activePage && activePage.id === 'dataEntryPage') {
        if (tableContainer.scrollTop > 300 || window.pageYOffset > 300) {
          scrollBtn.classList.add('show');
        } else {
          scrollBtn.classList.remove('show');
        }
      }
    });
  }
});

// Highlight current cell
function highlightCell(cell) {
  document.querySelectorAll('.highlight').forEach(c => c.classList.remove('highlight'));
  cell.classList.add('highlight');
}

// Get plot number from cell
function getPlotNumberFromCell(cell) {
  if (!cell) return null;
  const row = cell.parentElement;
  if (!row || !row.cells[0]) return null;
  return parseInt(row.cells[0].textContent);
}

// Get next editable cell with plot change detection
function getNextEditableCell(cell) {
  if (!cell) return null;
  
  const oldPlotNumber = getPlotNumberFromCell(cell);
  
  let nextCell = null;
  
  if (navigationDirection === 'horizontal') {
    nextCell = cell.nextElementSibling;
    while (nextCell && !nextCell.hasAttribute('contenteditable')) {
      nextCell = nextCell.nextElementSibling;
    }
    
    if (nextCell) {
      checkAndBeepOnPlotChange(oldPlotNumber, nextCell);
      return nextCell;
    }
    
    let nextRow = cell.parentElement.nextElementSibling;
    while (nextRow) {
      let firstEditableCell = nextRow.querySelector('td[contenteditable="true"]');
      if (firstEditableCell) {
        checkAndBeepOnPlotChange(oldPlotNumber, firstEditableCell);
        return firstEditableCell;
      }
      nextRow = nextRow.nextElementSibling;
    }
    return null;
    
  } else {
    const currentRow = cell.parentElement;
    const currentCellIndex = Array.from(currentRow.cells).indexOf(cell);
    
    let nextRow = currentRow.nextElementSibling;
    while (nextRow) {
      const sameColumnCell = nextRow.cells[currentCellIndex];
      if (sameColumnCell && sameColumnCell.hasAttribute('contenteditable')) {
        checkAndBeepOnPlotChange(oldPlotNumber, sameColumnCell);
        return sameColumnCell;
      }
      nextRow = nextRow.nextElementSibling;
    }
    
    const firstRow = document.querySelector('#dataTable tbody tr');
    if (!firstRow) return null;
    
    for (let i = currentCellIndex + 1; i < firstRow.cells.length; i++) {
      const nextColCell = firstRow.cells[i];
      if (nextColCell && nextColCell.hasAttribute('contenteditable')) {
        checkAndBeepOnPlotChange(oldPlotNumber, nextColCell);
        return nextColCell;
      }
    }
    
    return null;
  }
}

// Check if plot changed and beep
function checkAndBeepOnPlotChange(oldPlotNumber, newCell) {
  const newPlotNumber = getPlotNumberFromCell(newCell);
  
  if (oldPlotNumber !== null && newPlotNumber !== null && oldPlotNumber !== newPlotNumber) {
    playBeep();
  }
}

// Initialize voice recognition
function initVoiceRecognition() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    showToast('‚ùå Speech recognition not supported');
    return false;
  }
  
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = false;
  recognition.lang = 'en-US';
  
  recognition.onresult = function(event) {
    const transcript = event.results[event.results.length - 1][0].transcript.trim();
    console.log('Transcript:', transcript);
    
    if (currentCell) {
      if (batchMode) {
        processBatchInput(transcript);
      } else {
        processVoiceInput(transcript);
      }
    }
  };
  
  recognition.onerror = function(event) {
    console.error('Recognition error:', event.error);
    if (event.error === 'no-speech') {
      return;
    }
    showToast(`‚ö†Ô∏è Error: ${event.error}`);
  };
  
  recognition.onend = function() {
    if (isRecording) {
      recognition.start();
    }
  };
  
  return true;
}

// Toggle voice recording
function toggleVoiceRecording() {
  if (!recognition && !initVoiceRecognition()) {
    return;
  }
  
  if (isRecording) {
    stopVoiceRecording();
  } else {
    startVoiceRecording();
  }
}

// Start voice recording
function startVoiceRecording() {
  const firstEditableCell = document.querySelector('td[contenteditable="true"]');
  if (!firstEditableCell) {
    showToast('‚ö†Ô∏è Generate table first');
    return;
  }
  
  if (!currentCell) {
    currentCell = firstEditableCell;
    highlightCell(currentCell);
    currentCell.focus();
  }
  
  currentPlotNumber = getPlotNumberFromCell(currentCell);
  
  try {
    recognition.start();
    isRecording = true;
    document.getElementById('voiceBtn').textContent = '‚èπÔ∏è Stop Voice Input';
    document.getElementById('voiceBtn').className = 'btn-danger';
    document.getElementById('voiceStatus').textContent = 'üé§ Listening...';
    document.getElementById('voiceStatus').className = 'recording';
    
    const voiceFloatBtn = document.getElementById('voiceFloatBtn');
    voiceFloatBtn.textContent = '‚èπÔ∏è';
    voiceFloatBtn.classList.add('recording');
    
    showToast('üé§ Voice input started');
  } catch (e) {
    console.error('Start error:', e);
  }
}

// Stop voice recording
function stopVoiceRecording() {
  if (recognition) {
    recognition.stop();
  }
  isRecording = false;
  currentPlotNumber = null;
  document.getElementById('voiceBtn').textContent = 'üé§ Start Voice Input';
  document.getElementById('voiceBtn').className = 'btn-success';
  document.getElementById('voiceStatus').textContent = 'Ready to start';
  document.getElementById('voiceStatus').className = '';
  
  const voiceFloatBtn = document.getElementById('voiceFloatBtn');
  voiceFloatBtn.textContent = 'üé§';
  voiceFloatBtn.classList.remove('recording');
  
  showToast('‚èπÔ∏è Voice input stopped');
}

// Parse transcript - NUMBERS ONLY
function parseTranscript(text) {
  text = text.toLowerCase().trim();
  
  const directNumber = text.match(/^-?\d+\.?\d*$/);
  if (directNumber) {
    return text;
  }
  
  const wordToNumber = {
    'zero': '0', 'one': '1', 'two': '2', 'three': '3', 'four': '4',
    'five': '5', 'six': '6', 'seven': '7', 'eight': '8', 'nine': '9',
    'ten': '10', 'eleven': '11', 'twelve': '12', 'thirteen': '13',
    'fourteen': '14', 'fifteen': '15', 'sixteen': '16', 'seventeen': '17',
    'eighteen': '18', 'nineteen': '19', 'twenty': '20', 'thirty': '30',
    'forty': '40', 'fifty': '50', 'sixty': '60', 'seventy': '70',
    'eighty': '80', 'ninety': '90', 'hundred': '100'
  };
  
  if (wordToNumber[text]) {
    return wordToNumber[text];
  }
  
  const decimalMatch = text.match(/(\d+)\s*(?:point|dot)\s*(\d+)/);
  if (decimalMatch) {
    return `${decimalMatch[1]}.${decimalMatch[2]}`;
  }
  
  return null;
}

// Process voice input - NUMBERS ONLY
function processVoiceInput(transcript) {
  const value = parseTranscript(transcript);
  
  if (value === null) {
    console.log('Ignored non-numeric input:', transcript);
    return;
  }
  
  currentCell.textContent = value;
  saveTrialData();
  
  setTimeout(() => {
    const nextCell = getNextEditableCell(currentCell);
    if (nextCell) {
      currentCell = nextCell;
      highlightCell(currentCell);
      currentCell.focus();
    } else {
      document.getElementById('voiceStatus').textContent = 'All cells filled!';
      stopVoiceRecording();
    }
  }, 150);
}

// Process batch input - NUMBERS ONLY
function processBatchInput(transcript) {
  let values = [];
  const cleaned = transcript.trim();
  
  if (/^\d+$/.test(cleaned)) {
    values = cleaned.split('').filter(v => v);
  } else if (/^[\d\s]+$/.test(cleaned) && cleaned.includes(' ')) {
    values = cleaned.split(/\s+/).filter(v => v);
  } else {
    values = cleaned.split(/[,\s]+/)
      .map(v => parseTranscript(v.trim()))
      .filter(v => v !== null);
  }
  
  if (values.length === 0) {
    console.log('Ignored non-numeric batch input:', transcript);
    return;
  }
  
  let cellsToFill = [currentCell];
  let tempCell = currentCell;
  
  for (let i = 1; i < values.length; i++) {
    tempCell = getNextEditableCell(tempCell);
    if (tempCell) {
      cellsToFill.push(tempCell);
    } else {
      break;
    }
  }
  
  cellsToFill.forEach((cell, index) => {
    if (index < values.length) {
      cell.textContent = values[index];
    }
  });
  
  saveTrialData();
  
  setTimeout(() => {
    const lastFilledCell = cellsToFill[cellsToFill.length - 1];
    const nextCell = getNextEditableCell(lastFilledCell);
    if (nextCell) {
      currentCell = nextCell;
      highlightCell(currentCell);
      currentCell.focus();
    } else {
      document.getElementById('voiceStatus').textContent = 'All cells filled!';
      stopVoiceRecording();
    }
  }, 150);
}

// Save trial data
function saveTrialData() {
  if (!currentTrial) return;
  
  const rows = document.querySelectorAll('#dataTable tbody tr');
  currentTrial.data = [];
  
  rows.forEach(row => {
    const rowData = Array.from(row.cells).map(cell => cell.textContent);
    currentTrial.data.push(rowData);
  });
}

// Load trial data
function loadTrialData(data) {
  if (!data || data.length === 0) return;
  
  const rows = document.querySelectorAll('#dataTable tbody tr');
  rows.forEach((row, rowIndex) => {
    if (data[rowIndex]) {
      Array.from(row.cells).forEach((cell, cellIndex) => {
        if (data[rowIndex][cellIndex] !== undefined) {
          cell.textContent = data[rowIndex][cellIndex];
        }
      });
    }
  });
}

// Save and exit
function saveAndExit() {
  if (!currentTrial) {
    showPage('homePage');
    return;
  }
  
  saveTrialData();
  
  const trials = JSON.parse(localStorage.getItem('trials') || '[]');
  
  if (currentTrialIndex >= 0) {
    trials[currentTrialIndex] = currentTrial;
  } else {
    trials.push(currentTrial);
  }
  
  localStorage.setItem('trials', JSON.stringify(trials));
  
  currentTrial = null;
  currentTrialIndex = -1;
  
  showPage('homePage');
  loadTrialList();
  showToast('‚úÖ Trial saved');
}

// Export to CSV
function exportToCSV() {
  const table = document.getElementById('dataTable');
  if (!table.rows.length) {
    showToast('‚ö†Ô∏è No data to export');
    return;
  }
  
  let csv = [];
  
  const headers = Array.from(table.rows[0].cells).map(cell => cell.textContent);
  csv.push(headers.join(','));
  
  for (let i = 1; i < table.rows.length; i++) {
    const row = Array.from(table.rows[i].cells).map(cell => {
      const value = cell.textContent.replace(/"/g, '""');
      return `"${value}"`;
    });
    csv.push(row.join(','));
  }
  
  const csvContent = csv.join('\n');
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  
  const trialName = currentTrial ? currentTrial.name.replace(/\s+/g, '_') : 'trial';
  link.setAttribute('href', url);
  link.setAttribute('download', `${trialName}_${new Date().getTime()}.csv`);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  showToast('‚úÖ CSV exported successfully');
}

// Mode toggle
document.querySelectorAll('.mode-btn[data-mode]').forEach(btn => {
  btn.addEventListener('click', function() {
    const mode = this.getAttribute('data-mode');
    document.querySelectorAll('.mode-btn[data-mode]').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    batchMode = (mode === 'batch');
    showToast(`Mode: ${batchMode ? 'Batch üìä' : 'One-at-a-Time üìù'}`);
  });
});

// Direction toggle
document.getElementById('directionToggle').addEventListener('click', function() {
  navigationDirection = navigationDirection === 'horizontal' ? 'vertical' : 'horizontal';
  this.innerHTML = navigationDirection === 'horizontal' ? '‚û°Ô∏è Horizontal' : '‚¨áÔ∏è Vertical';
  showToast(`Navigation: ${navigationDirection === 'horizontal' ? 'Horizontal ‚û°Ô∏è' : 'Vertical ‚¨áÔ∏è'}`);
});

// Initialize
window.addEventListener('load', function() {
  loadTrialList();
});
</script>
</body>
</html>
