<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Syngenta Trial Data Entry</title>
    <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .content {
      padding: 40px;
    }

    .form-group {
      margin-bottom: 25px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
      font-size: 16px;
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      padding: 12px 30px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
      margin-left: 10px;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .btn-success {
      background: #28a745;
      color: white;
      margin-left: 10px;
    }

    .btn-success:hover {
      background: #218838;
    }

    .table-container {
      overflow-x: auto;
      margin-top: 30px;
      border: 2px solid #ddd;
      border-radius: 8px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    td {
      padding: 12px 15px;
      border: 1px solid #ddd;
      min-width: 100px;
    }

    td[contenteditable="true"] {
      cursor: text;
      background: #f8f9fa;
    }

    td[contenteditable="true"]:hover {
      background: #e9ecef;
    }

    td[contenteditable="true"]:focus {
      outline: 2px solid #667eea;
      background: #fff;
    }

    .cell-highlight {
      background: #fff3cd !important;
      outline: 3px solid #ffc107 !important;
    }

    .controls {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .assessment-manager {
      margin-top: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .assessment-manager h3 {
      margin-bottom: 15px;
      color: #333;
    }

    .assessment-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }

    .assessment-tag {
      background: #667eea;
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .assessment-tag button {
      background: rgba(255,255,255,0.3);
      border: none;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      cursor: pointer;
      font-size: 12px;
    }

    .assessment-tag button:hover {
      background: rgba(255,255,255,0.5);
    }

    #setupScreen, #dataEntryScreen {
      display: none;
    }

    .trial-selector {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .trial-selector h3 {
      margin-bottom: 15px;
      color: #333;
    }

    .trial-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .trial-card {
      background: white;
      padding: 15px 20px;
      border-radius: 8px;
      border: 2px solid #ddd;
      cursor: pointer;
      transition: all 0.3s;
    }

    .trial-card:hover {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    .trial-card.active {
      border-color: #667eea;
      background: #f0f4ff;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ðŸŒ¾ Syngenta Trial Data Entry</h1>
      <p>Professional Field Trial Management System</p>
    </div>

    <div class="content">
      <!-- Trial Selection Screen -->
      <div id="trialSelectionScreen">
        <div class="trial-selector">
          <h3>Select Existing Trial</h3>
          <div class="trial-list" id="trialList"></div>
        </div>
        <button class="btn btn-primary" onclick="showSetupScreen()" style="font-size: 18px; padding: 15px 40px;">
          âž• Create New Trial
        </button>
      </div>

      <!-- Setup Screen -->
      <div id="setupScreen">
        <h2 style="margin-bottom: 30px; color: #333;">Create New Trial</h2>
        
        <div class="form-group">
          <label for="code">Trial Code</label>
          <input type="text" id="code" placeholder="e.g., TRIAL-2024-001">
        </div>

        <div class="form-group">
          <label for="treatments">Number of Treatments</label>
          <input type="number" id="treatments" min="1" value="4">
        </div>

        <div class="form-group">
          <label for="reps">Number of Replications</label>
          <input type="number" id="reps" min="1" value="3">
        </div>

        <div class="form-group">
          <label for="subplots">Number of Subplots per Rep</label>
          <input type="number" id="subplots" min="1" value="2">
        </div>

        <button class="btn btn-primary" onclick="createTrial()" style="font-size: 18px; padding: 15px 40px;">
          Create Trial
        </button>
        <button class="btn btn-secondary" onclick="backToSelection()">
          Cancel
        </button>
      </div>

      <!-- Data Entry Screen -->
      <div id="dataEntryScreen">
        <h2 id="trialTitle" style="margin-bottom: 20px; color: #333;"></h2>

        <div class="assessment-manager">
          <h3>Assessment Columns</h3>
          <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <input type="text" id="newAssessment" placeholder="e.g., Plant Height" style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
            <button class="btn btn-primary" onclick="addAssessment()">Add Column</button>
          </div>
          <div class="assessment-list" id="assessmentList"></div>
        </div>

        <div class="table-container">
          <table>
            <thead id="tableHeader"></thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>

        <div class="controls">
          <button class="btn btn-success" onclick="exportToCSV()">ðŸ“¥ Export to CSV</button>
          <button class="btn btn-secondary" onclick="backToSelection()">ðŸ”™ Back to Trials</button>
        </div>
      </div>
    </div>
  </div>
    <script>
    let currentTrial = null;
    let assessmentColumns = ['Plant Height', 'Yield', 'Disease Score'];
    let currentCell = { row: 0, col: 0 }; // col 0 = first assessment column

    // Initialize app
    window.onload = function() {
      loadTrialList();
      document.getElementById('trialSelectionScreen').style.display = 'block';
    };

    // Load trial list from localStorage
    function loadTrialList() {
      const trials = getAllTrials();
      const trialList = document.getElementById('trialList');
      
      if (trials.length === 0) {
        trialList.innerHTML = '<p style="color: #666;">No trials yet. Create your first trial!</p>';
        return;
      }

      trialList.innerHTML = trials.map(trial => `
        <div class="trial-card" onclick="loadTrial('${trial.code}')">
          <strong>${trial.code}</strong><br>
          <small>${trial.data.length} records</small>
        </div>
      `).join('');
    }

    // Get all trials from localStorage
    function getAllTrials() {
      const trials = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('trial_')) {
          trials.push(JSON.parse(localStorage.getItem(key)));
        }
      }
      return trials;
    }

    // Show setup screen
    function showSetupScreen() {
      document.getElementById('trialSelectionScreen').style.display = 'none';
      document.getElementById('setupScreen').style.display = 'block';
    }

    // Back to selection
    function backToSelection() {
      document.getElementById('setupScreen').style.display = 'none';
      document.getElementById('dataEntryScreen').style.display = 'none';
      document.getElementById('trialSelectionScreen').style.display = 'block';
      loadTrialList();
    }

    // Create new trial
    function createTrial() {
      const code = document.getElementById('code').value.trim();
      const numTreatments = parseInt(document.getElementById('treatments').value);
      const numReps = parseInt(document.getElementById('reps').value);
      const numSubplots = parseInt(document.getElementById('subplots').value);

      if (!code || numTreatments < 1 || numReps < 1 || numSubplots < 1) {
        alert('Please fill all fields with valid numbers');
        return;
      }

      // Generate data structure
      const data = [];
      for (let t = 1; t <= numTreatments; t++) {
        for (let r = 1; r <= numReps; r++) {
          for (let s = 1; s <= numSubplots; s++) {
            const row = {
              treatment: `T${t}`,
              rep: `R${r}`,
              subplot: `S${s}`
            };
            assessmentColumns.forEach(col => row[col] = '');
            data.push(row);
          }
        }
      }

      currentTrial = { code, data };
      saveTrialToStorage(currentTrial);

      document.getElementById('setupScreen').style.display = 'none';
      document.getElementById('dataEntryScreen').style.display = 'block';
      document.getElementById('trialTitle').textContent = `Trial: ${code}`;

      renderTable();
      renderAssessmentList();
      highlightCurrentCell();
    }

    // Load existing trial
    function loadTrial(code) {
      const trial = JSON.parse(localStorage.getItem(`trial_${code}`));
      if (!trial) {
        alert('Trial not found');
        return;
      }

      currentTrial = trial;
      
      // Extract assessment columns from first data row
      if (trial.data.length > 0) {
        assessmentColumns = Object.keys(trial.data[0]).filter(
          key => !['treatment', 'rep', 'subplot'].includes(key)
        );
      }

      document.getElementById('trialSelectionScreen').style.display = 'none';
      document.getElementById('dataEntryScreen').style.display = 'block';
      document.getElementById('trialTitle').textContent = `Trial: ${code}`;

      renderTable();
      renderAssessmentList();
      highlightCurrentCell();
    }

    // Save trial to localStorage
    function saveTrialToStorage(trial) {
      localStorage.setItem(`trial_${trial.code}`, JSON.stringify(trial));
    }

    // Render table
    function renderTable() {
      const headerRow = document.getElementById('tableHeader');
      const tbody = document.getElementById('tableBody');

      // Create header
      headerRow.innerHTML = `
        <tr>
          <th>Treatment</th>
          <th>Rep</th>
          <th>Subplot</th>
          ${assessmentColumns.map(col => `<th>${col}</th>`).join('')}
        </tr>
      `;

      // Create data rows
      tbody.innerHTML = currentTrial.data.map((row, idx) => `
        <tr data-row="${idx}">
          <td>${row.treatment}</td>
          <td>${row.rep}</td>
          <td>${row.subplot}</td>
          ${assessmentColumns.map((col, colIdx) => `
            <td contenteditable="true" 
                data-row="${idx}" 
                data-col="${colIdx}"
                onblur="updateCell(${idx}, '${col}', this.textContent)"
                onfocus="setCurrentCell(${idx}, ${colIdx})"
            >${row[col] || ''}</td>
          `).join('')}
        </tr>
      `).join('');
    }

    // Render assessment list
    function renderAssessmentList() {
      const list = document.getElementById('assessmentList');
      list.innerHTML = assessmentColumns.map((col, idx) => `
        <div class="assessment-tag">
          ${col}
          <button onclick="removeAssessment(${idx})">Ã—</button>
        </div>
      `).join('');
    }

    // Add assessment column
    function addAssessment() {
      const input = document.getElementById('newAssessment');
      const name = input.value.trim();
      
      if (!name) {
        alert('Please enter a column name');
        return;
      }

      if (assessmentColumns.includes(name)) {
        alert('Column already exists');
        return;
      }

      assessmentColumns.push(name);
      
      // Add column to all data rows
      currentTrial.data.forEach(row => row[name] = '');
      
      saveTrialToStorage(currentTrial);
      renderTable();
      renderAssessmentList();
      
      input.value = '';
    }

    // Remove assessment column
    function removeAssessment(idx) {
      if (!confirm(`Remove "${assessmentColumns[idx]}" column?`)) return;
      
      const colName = assessmentColumns[idx];
      assessmentColumns.splice(idx, 1);
      
      // Remove from all data rows
      currentTrial.data.forEach(row => delete row[colName]);
      
      saveTrialToStorage(currentTrial);
      renderTable();
      renderAssessmentList();
    }

    // Update cell value
    function updateCell(rowIdx, colName, value) {
      currentTrial.data[rowIdx][colName] = value.trim();
      saveTrialToStorage(currentTrial);
    }

    // Set current cell for navigation
    function setCurrentCell(row, col) {
      currentCell = { row, col };
    }

    // Highlight current cell
    function highlightCurrentCell() {
      document.querySelectorAll('td[contenteditable]').forEach(td => {
        td.classList.remove('cell-highlight');
      });

      const cell = document.querySelector(`td[data-row="${currentCell.row}"][data-col="${currentCell.col}"]`);
      if (cell) {
        cell.classList.add('cell-highlight');
        cell.focus();
      }
    }

    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
      if (document.getElementById('dataEntryScreen').style.display !== 'block') return;
      
      const maxRow = currentTrial.data.length - 1;
      const maxCol = assessmentColumns.length - 1;

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (currentCell.row < maxRow) {
          currentCell.row++;
          highlightCurrentCell();
        }
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (currentCell.row > 0) {
          currentCell.row--;
          highlightCurrentCell();
        }
      } else if (e.key === 'ArrowRight' || e.key === 'Tab') {
        e.preventDefault();
        if (currentCell.col < maxCol) {
          currentCell.col++;
        } else if (currentCell.row < maxRow) {
          currentCell.col = 0;
          currentCell.row++;
        }
        highlightCurrentCell();
      } else if (e.key === 'ArrowLeft') {
        e.preventDefault();
        if (currentCell.col > 0) {
          currentCell.col--;
        } else if (currentCell.row > 0) {
          currentCell.col = maxCol;
          currentCell.row--;
        }
        highlightCurrentCell();
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (currentCell.row < maxRow) {
          currentCell.row++;
          highlightCurrentCell();
        }
      }
    });

    // Export to CSV
    function exportToCSV() {
      const headers = ['Treatment', 'Rep', 'Subplot', ...assessmentColumns];
      const rows = currentTrial.data.map(row => [
        row.treatment,
        row.rep,
        row.subplot,
        ...assessmentColumns.map(col => row[col] || '')
      ]);

      let csv = headers.join(',') + '\n';
      csv += rows.map(row => row.join(',')).join('\n');

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${currentTrial.code}_data.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
