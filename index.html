<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Field Trial Assessment</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 20px;
  overflow-x: hidden;
}

.container {
  max-width: 800px;
  margin: 0 auto;
  background: white;
  border-radius: 20px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  overflow: hidden;
}

.page {
  display: none;
  padding: 30px;
  animation: fadeIn 0.3s;
}

.page.active {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 25px;
  text-align: center;
  font-size: 24px;
  font-weight: bold;
  letter-spacing: 1px;
}

.btn {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  padding: 15px 30px;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
  margin: 10px 0;
  transition: all 0.3s;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.btn:active {
  transform: scale(0.98);
  box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
}

.btn-secondary {
  background: #6c757d;
  box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
}

.btn-danger {
  background: #dc3545;
  box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
}

.form-group {
  margin: 20px 0;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: #333;
}

.form-group input {
  width: 100%;
  padding: 12px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 16px;
  transition: border 0.3s;
}

.form-group input:focus {
  outline: none;
  border-color: #667eea;
}

.column-item {
  display: flex;
  gap: 10px;
  margin: 10px 0;
}

.column-item input {
  flex: 1;
  padding: 12px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 16px;
}

.delete-btn {
  background: #dc3545;
  color: white;
  border: none;
  width: 45px;
  border-radius: 8px;
  font-size: 24px;
  cursor: pointer;
  transition: all 0.3s;
}

.delete-btn:active {
  transform: scale(0.95);
}

.table-container {
  overflow-x: auto;
  margin: 20px 0;
  border-radius: 12px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

table {
  width: 100%;
  border-collapse: collapse;
  background: white;
}

th {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 15px;
  text-align: left;
  font-weight: 600;
  position: sticky;
  top: 0;
  z-index: 10;
}

td {
  padding: 12px;
  border-bottom: 1px solid #e0e0e0;
  transition: background 0.3s;
}

td.current-cell {
  background: #fff3cd !important;
  box-shadow: inset 0 0 0 3px #ffc107;
}

td input {
  width: 100%;
  padding: 8px;
  border: 2px solid #e0e0e0;
  border-radius: 6px;
  font-size: 16px;
}

td input:focus {
  outline: none;
  border-color: #667eea;
}

.status-bar {
  background: #f8f9fa;
  padding: 15px;
  border-radius: 12px;
  margin: 20px 0;
  text-align: center;
}

.status-bar.listening {
  background: #d4edda;
  border: 2px solid #28a745;
}

#statusText {
  font-size: 14px;
  color: #666;
  margin-top: 5px;
}

.controls {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin: 20px 0;
}

.field-mode {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: #1a1a1a;
  color: white;
  display: none;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  padding: 40px;
  text-align: center;
}

.field-mode.active {
  display: flex;
}

.field-mode-info {
  font-size: 48px;
  font-weight: bold;
  margin: 40px 0;
  line-height: 1.4;
}

.field-mode-btn {
  font-size: 24px;
  padding: 25px 50px;
  margin: 15px;
  border-radius: 15px;
}

.legend {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 30px;
  border-radius: 20px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  z-index: 2000;
  display: none;
  max-width: 90%;
  max-height: 80vh;
  overflow-y: auto;
}

.legend.active {
  display: block;
}

.legend-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.7);
  z-index: 1999;
  display: none;
}

.legend-overlay.active {
  display: block;
}

.legend h3 {
  margin-bottom: 20px;
  color: #667eea;
}

.legend-item {
  padding: 12px;
  margin: 8px 0;
  background: #f8f9fa;
  border-radius: 8px;
  display: flex;
  justify-content: space-between;
}

.legend-command {
  font-weight: 600;
  color: #667eea;
}

.settings-group {
  margin: 25px 0;
  padding: 20px;
  background: #f8f9fa;
  border-radius: 12px;
}

.settings-group h3 {
  margin-bottom: 15px;
  color: #333;
}

.toggle-switch {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin: 15px 0;
}

.switch {
  position: relative;
  width: 60px;
  height: 34px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: 0.4s;
  border-radius: 34px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 26px;
  width: 26px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: 0.4s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: #667eea;
}

input:checked + .slider:before {
  transform: translateX(26px);
}

.speed-control {
  margin: 15px 0;
}

.speed-control input[type="range"] {
  width: 100%;
  height: 8px;
  border-radius: 5px;
  background: #e0e0e0;
  outline: none;
  -webkit-appearance: none;
}

.speed-control input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: #667eea;
  cursor: pointer;
}

.speed-label {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  color: #666;
  margin-top: 5px;
}

.trial-list {
  margin: 20px 0;
}

.trial-item {
  background: #f8f9fa;
  padding: 15px;
  margin: 10px 0;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s;
  border: 2px solid transparent;
}

.trial-item:active {
  transform: scale(0.98);
  border-color: #667eea;
}

.trial-item-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.trial-id {
  font-weight: bold;
  color: #667eea;
  font-size: 18px;
}

.trial-name {
  font-size: 16px;
  color: #333;
  margin: 5px 0;
}

.trial-date {
  font-size: 14px;
  color: #666;
}

.trial-delete {
  background: #dc3545;
  color: white;
  border: none;
  padding: 8px 15px;
  border-radius: 6px;
  font-size: 14px;
  cursor: pointer;
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #999;
}

.empty-state-icon {
  font-size: 64px;
  margin-bottom: 20px;
}

@media (max-width: 600px) {
  .container {
    border-radius: 0;
  }
  
  .page {
    padding: 20px;
  }
  
  .controls {
    grid-template-columns: 1fr;
  }
  
  .field-mode-info {
    font-size: 32px;
  }
  
  .field-mode-btn {
    font-size: 18px;
    padding: 20px 40px;
  }
}
</style>
</head>
<body>
  <div class="container">
  <div class="header">Field Trial Assessment</div>

  <!-- Page 0: Home / Trial List -->
  <div id="page0" class="page active">
    <h2 style="margin-bottom: 20px;">Previous Trials</h2>
    <div id="trialList" class="trial-list"></div>
    <button class="btn" onclick="startNewTrial()">+ New Assessment</button>
  </div>

  <!-- Page 1: Trial Setup -->
  <div id="page1" class="page">
    <button class="btn btn-secondary" onclick="goToPage(0)">‚Üê Back to Home</button>
    
    <div class="form-group">
      <label>Trial ID</label>
      <input type="text" id="trialId" placeholder="Enter trial ID">
    </div>
    
    <div class="form-group">
      <label>Trial Name</label>
      <input type="text" id="trialName" placeholder="Enter trial name">
    </div>
    
    <div class="form-group">
      <label>Assessment Date</label>
      <input type="date" id="assessmentDate">
    </div>
    
    <div class="form-group">
      <label>Number of Rows</label>
      <input type="number" id="numRows" value="10" min="1">
    </div>
    
    <div class="form-group">
      <label>Number of Columns</label>
      <input type="number" id="numCols" value="5" min="1">
    </div>
    
    <h3 style="margin-top: 30px;">Column Names</h3>
    <div id="columnNames"></div>
    <button class="btn btn-secondary" onclick="addColumn()">+ Add Column</button>
    
    <button class="btn" onclick="generateTable()" style="margin-top: 30px;">Generate Table</button>
  </div>

  <!-- Page 2: Data Entry -->
  <div id="page2" class="page">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3 id="trialInfo"></h3>
      <button class="btn btn-secondary" onclick="goToPage(1)" style="width: auto; padding: 10px 20px;">Edit Setup</button>
    </div>
    
    <div class="status-bar" id="statusBar">
      <div style="font-size: 18px; font-weight: bold;" id="currentPosition">Ready</div>
      <div id="statusText">Tap "Start Voice" to begin</div>
    </div>
    
    <div class="controls">
      <button class="btn" id="voiceBtn" onclick="toggleVoice()">üé§ Start Voice</button>
      <button class="btn btn-secondary" onclick="toggleFieldMode()">üì± Field Mode</button>
      <button class="btn btn-secondary" onclick="showLegend()">üìñ Commands</button>
      <button class="btn btn-secondary" onclick="goToPage(3)">‚öôÔ∏è Settings</button>
    </div>
    
    <div class="table-container">
      <table id="dataTable"></table>
    </div>
    
    <div class="controls">
      <button class="btn" onclick="exportCSV()">üì• Export CSV</button>
      <button class="btn btn-danger" onclick="clearData()">üóëÔ∏è Clear Data</button>
    </div>
  </div>

  <!-- Page 3: Settings -->
  <div id="page3" class="page">
    <button class="btn btn-secondary" onclick="goToPage(2)">‚Üê Back to Data Entry</button>
    
    <div class="settings-group">
      <h3>Voice Recognition</h3>
      
      <div class="toggle-switch">
        <span>Auto-advance after entry</span>
        <label class="switch">
          <input type="checkbox" id="autoAdvance" checked>
          <span class="slider"></span>
        </label>
      </div>
      
      <div class="toggle-switch">
        <span>Voice feedback</span>
        <label class="switch">
          <input type="checkbox" id="voiceFeedback" checked>
          <span class="slider"></span>
        </label>
      </div>
      
      <div class="speed-control">
        <label>Speech Rate</label>
        <input type="range" id="speechRate" min="0.5" max="2" step="0.1" value="1">
        <div class="speed-label">
          <span>Slow</span>
          <span id="rateValue">1.0x</span>
          <span>Fast</span>
        </div>
      </div>
    </div>
    
    <div class="settings-group">
      <h3>Navigation</h3>
      
      <div class="toggle-switch">
        <span>Confirm before moving</span>
        <label class="switch">
          <input type="checkbox" id="confirmMove">
          <span class="slider"></span>
        </label>
      </div>
      
      <div class="toggle-switch">
        <span>Wrap around edges</span>
        <label class="switch">
          <input type="checkbox" id="wrapAround" checked>
          <span class="slider"></span>
        </label>
      </div>
    </div>
    
    <div class="settings-group">
      <h3>Data Entry</h3>
      
      <div class="toggle-switch">
        <span>Auto-save</span>
        <label class="switch">
          <input type="checkbox" id="autoSave" checked>
          <span class="slider"></span>
        </label>
      </div>
    </div>
  </div>
</div>

<!-- Field Mode Overlay -->
<div id="fieldMode" class="field-mode">
  <div class="field-mode-info">
    <div id="fieldPosition">Row 1, Column 1</div>
    <div id="fieldValue" style="font-size: 64px; margin: 40px 0;">-</div>
  </div>
  <button class="btn field-mode-btn" onclick="toggleVoice()">üé§ Toggle Voice</button>
  <button class="btn btn-secondary field-mode-btn" onclick="toggleFieldMode()">‚Üê Exit Field Mode</button>
</div>

<!-- Legend Overlay -->
<div class="legend-overlay" id="legendOverlay" onclick="hideLegend()"></div>
<div class="legend" id="legend">
  <h3>Voice Commands</h3>
  <div class="legend-item">
    <span class="legend-command">"Next" or "Right"</span>
    <span>Move to next cell</span>
  </div>
  <div class="legend-item">
    <span class="legend-command">"Previous" or "Left"</span>
    <span>Move to previous cell</span>
  </div>
  <div class="legend-item">
    <span class="legend-command">"Down"</span>
    <span>Move down one row</span>
  </div>
  <div class="legend-item">
    <span class="legend-command">"Up"</span>
    <span>Move up one row</span>
  </div>
  <div class="legend-item">
    <span class="legend-command">"Row [number]"</span>
    <span>Jump to specific row</span>
  </div>
  <div class="legend-item">
    <span class="legend-command">"Column [number]"</span>
    <span>Jump to specific column</span>
  </div>
  <div class="legend-item">
    <span class="legend-command">"Delete" or "Clear"</span>
    <span>Clear current cell</span>
  </div>
  <div class="legend-item">
    <span class="legend-command">"Repeat"</span>
    <span>Repeat current position</span>
  </div>
  <div class="legend-item">
    <span class="legend-command">Any number/text</span>
    <span>Enter data in current cell</span>
  </div>
  <button class="btn" onclick="hideLegend()" style="margin-top: 20px;">Close</button>
</div>

<script>
  // Global variables
let currentRow = 0;
let currentCol = 0;
let recognition = null;
let isListening = false;
let tableData = [];
let trialConfig = {};
let synth = window.speechSynthesis;
let currentTrialId = null;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  setTodayDate();
  loadTrials();
  initSpeechRecognition();
  initSettings();
  updateColumnInputs();
});

function setTodayDate() {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('assessmentDate').value = today;
}

function initSettings() {
  document.getElementById('speechRate').addEventListener('input', function(e) {
    document.getElementById('rateValue').textContent = e.target.value + 'x';
  });
}

function updateColumnInputs() {
  const numCols = parseInt(document.getElementById('numCols').value) || 5;
  const container = document.getElementById('columnNames');
  container.innerHTML = '';
  
  for (let i = 0; i < numCols; i++) {
    const div = document.createElement('div');
    div.className = 'column-item';
    div.innerHTML = `
      <input type="text" placeholder="Column ${i + 1} name" value="Column ${i + 1}" id="col${i}">
      ${i > 0 ? '<button class="delete-btn" onclick="removeColumn(this)">√ó</button>' : ''}
    `;
    container.appendChild(div);
  }
}

document.getElementById('numCols').addEventListener('input', updateColumnInputs);

function addColumn() {
  const numCols = parseInt(document.getElementById('numCols').value) || 5;
  document.getElementById('numCols').value = numCols + 1;
  updateColumnInputs();
}

function removeColumn(btn) {
  btn.parentElement.remove();
  const numCols = document.querySelectorAll('.column-item').length;
  document.getElementById('numCols').value = numCols;
}

function generateTable() {
  const trialId = document.getElementById('trialId').value.trim();
  const trialName = document.getElementById('trialName').value.trim();
  const assessmentDate = document.getElementById('assessmentDate').value;
  const numRows = parseInt(document.getElementById('numRows').value);
  const numCols = document.querySelectorAll('.column-item').length;
  
  if (!trialId || !trialName) {
    speak('Please enter trial ID and name');
    return;
  }
  
  const columnNames = [];
  for (let i = 0; i < numCols; i++) {
    const input = document.getElementById(`col${i}`);
    columnNames.push(input ? input.value : `Column ${i + 1}`);
  }
  
  trialConfig = {
    trialId,
    trialName,
    assessmentDate,
    numRows,
    numCols,
    columnNames,
    createdDate: new Date().toISOString()
  };
  
  currentTrialId = trialId;
  
  tableData = Array(numRows).fill().map(() => Array(numCols).fill(''));
  
  const table = document.getElementById('dataTable');
  table.innerHTML = '';
  
  const thead = table.createTHead();
  const headerRow = thead.insertRow();
  headerRow.insertCell().textContent = 'Row';
  columnNames.forEach(name => {
    const th = document.createElement('th');
    th.textContent = name;
    headerRow.appendChild(th);
  });
  
  const tbody = table.createTBody();
  for (let i = 0; i < numRows; i++) {
    const row = tbody.insertRow();
    const rowHeader = row.insertCell();
    rowHeader.textContent = i + 1;
    rowHeader.style.fontWeight = 'bold';
    rowHeader.style.background = '#f8f9fa';
    
    for (let j = 0; j < numCols; j++) {
      const cell = row.insertCell();
      const input = document.createElement('input');
      input.type = 'text';
      input.dataset.row = i;
      input.dataset.col = j;
      input.value = tableData[i][j];
      input.addEventListener('input', function() {
        tableData[i][j] = this.value;
        if (document.getElementById('autoSave').checked) {
          saveTrial();
        }
      });
      cell.appendChild(input);
    }
  }
  
  currentRow = 0;
  currentCol = 0;
  updateCurrentCell();
  
  document.getElementById('trialInfo').textContent = `${trialName} (${trialId})`;
  
  saveTrial();
  goToPage(2);
  speak('Table generated. Ready to start.');
}

function updateCurrentCell() {
  document.querySelectorAll('td').forEach(td => td.classList.remove('current-cell'));
  
  const cell = document.querySelector(`input[data-row="${currentRow}"][data-col="${currentCol}"]`);
  if (cell) {
    cell.parentElement.classList.add('current-cell');
    cell.focus();
    
    const colName = trialConfig.columnNames[currentCol];
    document.getElementById('currentPosition').textContent = 
      `Row ${currentRow + 1}, ${colName}`;
    document.getElementById('fieldPosition').textContent = 
      `Row ${currentRow + 1}, ${colName}`;
    document.getElementById('fieldValue').textContent = 
      tableData[currentRow][currentCol] || '-';
  }
}

function initSpeechRecognition() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    console.error('Speech recognition not supported');
    return;
  }
  
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = false;
  recognition.lang = 'en-US';
  
  recognition.onresult = function(event) {
    const last = event.results.length - 1;
    const command = event.results[last][0].transcript.toLowerCase().trim();
    
    document.getElementById('statusText').textContent = `Heard: "${command}"`;
    processCommand(command);
  };
  
  recognition.onerror = function(event) {
    console.error('Speech recognition error:', event.error);
    if (event.error === 'no-speech') {
      document.getElementById('statusText').textContent = 'No speech detected. Try again.';
    }
  };
  
  recognition.onend = function() {
    if (isListening) {
      recognition.start();
    }
  };
}

function toggleVoice() {
  if (!recognition) {
    speak('Speech recognition not available');
    return;
  }
  
  isListening = !isListening;
  const btn = document.getElementById('voiceBtn');
  const statusBar = document.getElementById('statusBar');
  
  if (isListening) {
    recognition.start();
    btn.textContent = '‚è∏Ô∏è Stop Voice';
    btn.classList.remove('btn');
    btn.classList.add('btn-danger');
    statusBar.classList.add('listening');
    document.getElementById('statusText').textContent = 'Listening...';
    speak('Voice recognition started');
  } else {
    recognition.stop();
    btn.textContent = 'üé§ Start Voice';
    btn.classList.remove('btn-danger');
    btn.classList.add('btn');
    statusBar.classList.remove('listening');
    document.getElementById('statusText').textContent = 'Voice recognition stopped';
    speak('Voice recognition stopped');
  }
}

function processCommand(command) {
  const numMatch = command.match(/\d+/);
  
  if (command.includes('next') || command.includes('right')) {
    moveNext();
  } else if (command.includes('previous') || command.includes('left') || command.includes('back')) {
    movePrevious();
  } else if (command.includes('down')) {
    moveDown();
  } else if (command.includes('up')) {
    moveUp();
  } else if (command.includes('row') && numMatch) {
    jumpToRow(parseInt(numMatch[0]) - 1);
  } else if (command.includes('column') && numMatch) {
    jumpToColumn(parseInt(numMatch[0]) - 1);
  } else if (command.includes('delete') || command.includes('clear')) {
    clearCurrentCell();
  } else if (command.includes('repeat')) {
    repeatPosition();
  } else {
    enterData(command);
  }
}

function moveNext() {
  const confirmMove = document.getElementById('confirmMove').checked;
  if (confirmMove && !confirm('Move to next cell?')) return;
  
  currentCol++;
  if (currentCol >= trialConfig.numCols) {
    if (document.getElementById('wrapAround').checked) {
      currentCol = 0;
      currentRow++;
      if (currentRow >= trialConfig.numRows) {
        currentRow = 0;
      }
    } else {
      currentCol = trialConfig.numCols - 1;
      speak('End of row');
      return;
    }
  }
  updateCurrentCell();
  speak(`Row ${currentRow + 1}, ${trialConfig.columnNames[currentCol]}`);
}

function movePrevious() {
  currentCol--;
  if (currentCol < 0) {
    if (document.getElementById('wrapAround').checked) {
      currentCol = trialConfig.numCols - 1;
      currentRow--;
      if (currentRow < 0) {
        currentRow = trialConfig.numRows - 1;
      }
    } else {
      currentCol = 0;
      speak('Start of row');
      return;
    }
  }
  updateCurrentCell();
  speak(`Row ${currentRow + 1}, ${trialConfig.columnNames[currentCol]}`);
}

function moveDown() {
  currentRow++;
  if (currentRow >= trialConfig.numRows) {
    if (document.getElementById('wrapAround').checked) {
      currentRow = 0;
    } else {
      currentRow = trialConfig.numRows - 1;
      speak('Last row');
      return;
    }
  }
  updateCurrentCell();
  speak(`Row ${currentRow + 1}`);
}

function moveUp() {
  currentRow--;
  if (currentRow < 0) {
    if (document.getElementById('wrapAround').checked) {
      currentRow = trialConfig.numRows - 1;
    } else {
      currentRow = 0;
      speak('First row');
      return;
    }
  }
  updateCurrentCell();
  speak(`Row ${currentRow + 1}`);
}

function jumpToRow(row) {
  if (row >= 0 && row < trialConfig.numRows) {
    currentRow = row;
    updateCurrentCell();
    speak(`Jumped to row ${row + 1}`);
  } else {
    speak('Invalid row number');
  }
}

function jumpToColumn(col) {
  if (col >= 0 && col < trialConfig.numCols) {
    currentCol = col;
    updateCurrentCell();
    speak(`Jumped to ${trialConfig.columnNames[col]}`);
  } else {
    speak('Invalid column number');
  }
}

function clearCurrentCell() {
  tableData[currentRow][currentCol] = '';
  const input = document.querySelector(`input[data-row="${currentRow}"][data-col="${currentCol}"]`);
  if (input) {
    input.value = '';
  }
  document.getElementById('fieldValue').textContent = '-';
  speak('Cleared');
  if (document.getElementById('autoSave').checked) {
    saveTrial();
  }
}

function repeatPosition() {
  speak(`Row ${currentRow + 1}, ${trialConfig.columnNames[currentCol]}. Current value: ${tableData[currentRow][currentCol] || 'empty'}`);
}

function enterData(value) {
  tableData[currentRow][currentCol] = value;
  const input = document.querySelector(`input[data-row="${currentRow}"][data-col="${currentCol}"]`);
  if (input) {
    input.value = value;
  }
  document.getElementById('fieldValue').textContent = value;
  
  if (document.getElementById('voiceFeedback').checked) {
    speak(`Entered ${value}`);
  }
  
  if (document.getElementById('autoSave').checked) {
    saveTrial();
  }
  
  if (document.getElementById('autoAdvance').checked) {
    setTimeout(moveNext, 500);
  }
}

function speak(text) {
  if (!document.getElementById('voiceFeedback').checked) return;
  
  synth.cancel();
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.rate = parseFloat(document.getElementById('speechRate').value);
  synth.speak(utterance);
}

function exportCSV() {
  let csv = trialConfig.columnNames.join(',') + '\n';
  tableData.forEach((row, i) => {
    csv += row.join(',') + '\n';
  });
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${trialConfig.trialId}_${trialConfig.assessmentDate}.csv`;
  a.click();
  
  speak('Data exported');
}

function clearData() {
  if (!confirm('Clear all data? This cannot be undone.')) return;
  
  tableData = tableData.map(row => row.map(() => ''));
  document.querySelectorAll('#dataTable input').forEach(input => input.value = '');
  currentRow = 0;
  currentCol = 0;
  updateCurrentCell();
  
  if (document.getElementById('autoSave').checked) {
    saveTrial();
  }
  
  speak('All data cleared');
}

function toggleFieldMode() {
  const fieldMode = document.getElementById('fieldMode');
  fieldMode.classList.toggle('active');
  
  if (fieldMode.classList.contains('active')) {
    speak('Field mode activated');
  } else {
    speak('Field mode deactivated');
  }
}

function showLegend() {
  document.getElementById('legend').classList.add('active');
  document.getElementById('legendOverlay').classList.add('active');
}

function hideLegend() {
  document.getElementById('legend').classList.remove('active');
  document.getElementById('legendOverlay').classList.remove('active');
}

function goToPage(pageNum) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(`page${pageNum}`).classList.add('active');
  
  if (pageNum === 0) {
    loadTrials();
  }
}

function saveTrial() {
  if (!currentTrialId) return;
  
  const trial = {
    ...trialConfig,
    tableData,
    lastModified: new Date().toISOString()
  };
  
  localStorage.setItem(`trial_${currentTrialId}`, JSON.stringify(trial));
}

function loadTrials() {
  const trialList = document.getElementById('trialList');
  trialList.innerHTML = '';
  
  const trials = [];
  for (let i = 0; i < localStorage.length; i++)
