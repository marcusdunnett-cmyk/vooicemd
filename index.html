<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>voiceMD - Voice Data Collection</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    
    .page {
      display: none;
      padding: 30px;
    }
    
    .page.active {
      display: block;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      margin: 5px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    .btn-success {
      background: #10b981;
      color: white;
    }
    
    .btn-danger {
      background: #ef4444;
      color: white;
    }
    
    .btn-secondary {
      background: #6b7280;
      color: white;
    }
    
    .btn-warning {
      background: #f59e0b;
      color: white;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #374151;
    }
    
    .form-group input, .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .trial-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .trial-card {
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .trial-card:hover {
      border-color: #667eea;
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .trial-card h3 {
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .trial-card p {
      color: #6b7280;
      font-size: 14px;
      margin: 5px 0;
    }
    
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      align-items: center;
      justify-content: center;
    }
    
    .status {
      background: #f3f4f6;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
      border: 2px solid #e5e7eb;
      transition: all 0.3s;
    }
    
    .status.listening {
      background: #dcfce7;
      border-color: #10b981;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
    
    .status-text {
      font-size: 18px;
      font-weight: 600;
      color: #374151;
    }
    
    .table-container {
      overflow-x: auto;
      margin-top: 20px;
      border-radius: 8px;
      border: 2px solid #e5e7eb;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }
    
    th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    td {
      padding: 12px;
      border: 1px solid #e5e7eb;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    td:hover {
      background: #f9fafb;
    }
    
    td[contenteditable="true"]:focus {
      outline: 2px solid #667eea;
      background: #eff6ff;
    }
    
    .current-cell {
      background: #fef3c7 !important;
      border: 2px solid #f59e0b !important;
      animation: highlight 1s ease-in-out;
    }
    
    @keyframes highlight {
      0%, 100% { background: #fef3c7; }
      50% { background: #fde68a; }
    }
    
    .legend {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      max-width: 300px;
      display: none;
      z-index: 1000;
    }
    
    .legend.active {
      display: block;
    }
    
    .legend h3 {
      margin-bottom: 15px;
      color: #667eea;
    }
    
    .legend-item {
      margin: 10px 0;
      font-size: 14px;
      color: #374151;
    }
    
    .legend-item strong {
      color: #667eea;
    }
    
    .watermark {
      text-align: center;
      padding: 20px;
      color: #9ca3af;
      font-size: 14px;
      font-style: italic;
    }
    
    .settings-panel {
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .settings-panel h3 {
      color: #667eea;
      margin-bottom: 15px;
    }
    
    .toggle-switch {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }
    
    .toggle-switch input[type="checkbox"] {
      width: 50px;
      height: 26px;
      position: relative;
      appearance: none;
      background: #cbd5e1;
      border-radius: 13px;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .toggle-switch input[type="checkbox"]:checked {
      background: #10b981;
    }
    
    .toggle-switch input[type="checkbox"]::before {
      content: '';
      position: absolute;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: white;
      top: 2px;
      left: 2px;
      transition: transform 0.3s;
    }
    
    .toggle-switch input[type="checkbox"]:checked::before {
      transform: translateX(24px);
    }
    
    .mode-indicator {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 14px;
      margin: 10px 0;
    }
    
    .mode-single {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .mode-batch {
      background: #fce7f3;
      color: #be185d;
    }
    
    @media (max-width: 768px) {
      .header h1 {
        font-size: 1.8em;
      }
      
      .controls {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üé§ voiceMD</h1>
      <p>Voice-Powered Data Collection System</p>
    </div>

    <!-- STARTUP PAGE -->
    <div id="startupPage" class="page active">
      <h2 style="text-align: center; color: #667eea; margin-bottom: 30px;">Welcome to voiceMD</h2>
      
      <div class="form-group">
        <label>üìã Trial Code</label>
        <input type="text" id="trialCode" placeholder="Enter trial code (e.g., TRIAL001)">
      </div>
      
      <div class="form-group">
        <label>üåæ Crop</label>
        <select id="crop">
          <option value="">Select Crop</option>
          <option value="Corn">Corn</option>
          <option value="Soybean">Soybean</option>
          <option value="Wheat">Wheat</option>
          <option value="Cotton">Cotton</option>
          <option value="Rice">Rice</option>
          <option value="Canola">Canola</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>üìä Number of Plots</label>
        <input type="number" id="numPlots" min="1" max="100" value="10">
      </div>
      
      <div style="text-align: center; margin-top: 30px;">
        <button class="btn btn-primary" onclick="createTrial()" style="font-size: 18px; padding: 15px 40px;">
          ‚ú® Create New Trial
        </button>
      </div>
      
      <div id="trialList" class="trial-list"></div>
      
      <div class="watermark">
        By Mr Sa
      </div>
    </div>

    <!-- DATA COLLECTION PAGE -->
    <div id="dataPage" class="page">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap;">
        <h2 style="color: #667eea;">üìä <span id="currentTrialName"></span></h2>
        <button class="btn btn-secondary" onclick="backToStartup()">‚Üê Back to Trials</button>
      </div>

      <!-- SETTINGS PANEL -->
      <div class="settings-panel">
        <h3>‚öôÔ∏è Voice Recognition Settings</h3>
        
        <div class="toggle-switch">
          <input type="checkbox" id="batchModeToggle" onchange="toggleBatchMode()">
          <label for="batchModeToggle">
            <strong>Batch Mode</strong> (Record multiple numbers in succession)
          </label>
        </div>
        
        <div class="mode-indicator" id="modeIndicator">
          <span id="modeText">Single Cell Mode</span>
        </div>
        
        <div class="toggle-switch">
          <input type="checkbox" id="multiplesOf5Toggle" onchange="toggleMultiplesOf5()">
          <label for="multiplesOf5Toggle">
            <strong>Multiples of 5 Only</strong> (0, 5, 10, 15, 20, 25...)
          </label>
        </div>
      </div>

      <!-- STATUS DISPLAY -->
      <div class="status" id="status">
        <div class="status-text" id="statusText">Ready to start</div>
        <div style="margin-top: 10px; color: #6b7280;" id="transcriptDisplay"></div>
      </div>

      <!-- CONTROLS -->
      <div class="controls">
        <button class="btn btn-success" id="startBtn" onclick="startListening()">
          üé§ Start Voice Input
        </button>
        <button class="btn btn-danger" id="stopBtn" onclick="stopListening()" style="display: none;">
          ‚èπÔ∏è Stop Voice Input
        </button>
        <button class="btn btn-warning" onclick="toggleLegend()">
          ‚ùì Voice Commands
        </button>
        <button class="btn btn-primary" onclick="exportToCSV()">
          üíæ Export CSV
        </button>
      </div>

      <!-- DATA TABLE -->
      <div class="table-container">
        <table id="dataTable">
          <thead>
            <tr>
              <th>Plot</th>
              <th>Rating</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- LEGEND -->
  <div class="legend" id="legend">
    <h3>üé§ Voice Commands</h3>
    <div class="legend-item">
      <strong>Single Cell Mode:</strong><br>
      Say a number ‚Üí Auto-advances to next cell
    </div>
    <div class="legend-item">
      <strong>Batch Mode:</strong><br>
      Say multiple numbers: "5, 10, 15, 20"<br>
      Fills consecutive cells automatically
    </div>
    <div class="legend-item">
      <strong>Accepted Numbers:</strong><br>
      <span id="acceptedNumbers">All numbers (0-100)</span>
    </div>
    <div class="legend-item">
      <strong>Navigation:</strong><br>
      "Next" or "Skip" ‚Üí Move to next cell<br>
      "Previous" or "Back" ‚Üí Move to previous cell
    </div>
    <div class="legend-item">
      <strong>Special Commands:</strong><br>
      "Clear" ‚Üí Clear current cell<br>
      "Pause" ‚Üí Stop batch recording
    </div>
    <div style="text-align: center; margin-top: 15px;">
      <button class="btn btn-secondary" onclick="toggleLegend()">Close</button>
    </div>
  </div>
    <script>
    // ============================================
    // STATE MANAGEMENT
    // ============================================
    let currentTrial = null;
    let recognition = null;
    let isListening = false;
    let currentCellIndex = 0;
    let isBatchMode = false;
    let multiplesOf5Only = false;
    let audioContext = null;
    
    // ============================================
    // INITIALIZATION
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
      loadTrials();
      initAudioContext();
      updateAcceptedNumbersDisplay();
    });
    
    function initAudioContext() {
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      } catch (e) {
        console.warn('Audio context not available');
      }
    }
    
    // ============================================
    // AUDIO FEEDBACK
    // ============================================
    function playBeep(frequency = 800, duration = 100) {
      if (!audioContext) return;
      
      try {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = frequency;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + duration / 1000);
      } catch (e) {
        console.warn('Beep failed:', e);
      }
    }
    
    // ============================================
    // TRIAL MANAGEMENT
    // ============================================
    function createTrial() {
      const trialCode = document.getElementById('trialCode').value.trim();
      const crop = document.getElementById('crop').value;
      const numPlots = parseInt(document.getElementById('numPlots').value);
      
      if (!trialCode) {
        alert('Please enter a trial code');
        return;
      }
      
      if (!crop) {
        alert('Please select a crop');
        return;
      }
      
      if (numPlots < 1 || numPlots > 100) {
        alert('Number of plots must be between 1 and 100');
        return;
      }
      
      const trial = {
        id: Date.now(),
        code: trialCode,
        crop: crop,
        numPlots: numPlots,
        createdAt: new Date().toISOString(),
        data: []
      };
      
      // Initialize empty data
      for (let i = 0; i < numPlots; i++) {
        trial.data.push({
          plot: i + 1,
          rating: '',
          notes: ''
        });
      }
      
      saveTrialToStorage(trial);
      loadTrial(trial);
    }
    
    function saveTrialToStorage(trial) {
      let trials = JSON.parse(localStorage.getItem('voiceMD_trials') || '[]');
      const existingIndex = trials.findIndex(t => t.id === trial.id);
      
      if (existingIndex >= 0) {
        trials[existingIndex] = trial;
      } else {
        trials.push(trial);
      }
      
      localStorage.setItem('voiceMD_trials', JSON.stringify(trials));
      loadTrials();
    }
    
    function loadTrials() {
      const trials = JSON.parse(localStorage.getItem('voiceMD_trials') || '[]');
      const trialList = document.getElementById('trialList');
      
      if (trials.length === 0) {
        trialList.innerHTML = '<p style="text-align: center; color: #9ca3af; margin-top: 30px;">No trials yet. Create your first trial above!</p>';
        return;
      }
      
      trialList.innerHTML = trials.map(trial => `
        <div class="trial-card" onclick="loadTrialById(${trial.id})">
          <h3>${trial.code}</h3>
          <p><strong>Crop:</strong> ${trial.crop}</p>
          <p><strong>Plots:</strong> ${trial.numPlots}</p>
          <p><strong>Created:</strong> ${new Date(trial.createdAt).toLocaleDateString()}</p>
          <button class="btn btn-danger" style="margin-top: 10px; width: 100%;" onclick="event.stopPropagation(); deleteTrial(${trial.id})">
            üóëÔ∏è Delete
          </button>
        </div>
      `).join('');
    }
    
    function loadTrialById(id) {
      const trials = JSON.parse(localStorage.getItem('voiceMD_trials') || '[]');
      const trial = trials.find(t => t.id === id);
      if (trial) {
        loadTrial(trial);
      }
    }
    
    function loadTrial(trial) {
      currentTrial = trial;
      document.getElementById('currentTrialName').textContent = `${trial.code} - ${trial.crop}`;
      
      // Build table
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = trial.data.map((row, index) => `
        <tr>
          <td>${row.plot}</td>
          <td contenteditable="true" data-index="${index}" data-field="rating" 
              onclick="selectCell(${index}, 'rating')"
              onblur="saveCell(${index}, 'rating', this.textContent)">${row.rating}</td>
          <td contenteditable="true" data-index="${index}" data-field="notes"
              onclick="selectCell(${index}, 'notes')"
              onblur="saveCell(${index}, 'notes', this.textContent)">${row.notes}</td>
        </tr>
      `).join('');
      
      // Switch to data page
      document.getElementById('startupPage').classList.remove('active');
      document.getElementById('dataPage').classList.add('active');
      
      // Reset state
      currentCellIndex = 0;
      highlightCurrentCell();
    }
    
    function deleteTrial(id) {
      if (!confirm('Are you sure you want to delete this trial?')) return;
      
      let trials = JSON.parse(localStorage.getItem('voiceMD_trials') || '[]');
      trials = trials.filter(t => t.id !== id);
      localStorage.setItem('voiceMD_trials', JSON.stringify(trials));
      loadTrials();
    }
    
    function backToStartup() {
      if (isListening) {
        stopListening();
      }
      
      document.getElementById('dataPage').classList.remove('active');
      document.getElementById('startupPage').classList.add('active');
      currentTrial = null;
    }
    
    // ============================================
    // CELL MANAGEMENT
    // ============================================
    function selectCell(index, field) {
      currentCellIndex = index;
      highlightCurrentCell();
    }
    
    function saveCell(index, field, value) {
      if (!currentTrial) return;
      currentTrial.data[index][field] = value.trim();
      saveTrialToStorage(currentTrial);
    }
    
    function highlightCurrentCell() {
      // Remove all highlights
      document.querySelectorAll('.current-cell').forEach(cell => {
        cell.classList.remove('current-cell');
      });
      
      // Highlight current cell (rating column)
      const cell = document.querySelector(`td[data-index="${currentCellIndex}"][data-field="rating"]`);
      if (cell) {
        cell.classList.add('current-cell');
        cell.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
    
    function moveToNextCell() {
      if (!currentTrial) return;
      
      if (currentCellIndex < currentTrial.data.length - 1) {
        currentCellIndex++;
        highlightCurrentCell();
        playBeep(900, 80);
        return true;
      } else {
        updateStatus('‚úÖ All plots completed!');
        playBeep(1200, 150);
        return false;
      }
    }
    
    function moveToPreviousCell() {
      if (currentCellIndex > 0) {
        currentCellIndex--;
        highlightCurrentCell();
        playBeep(700, 80);
      }
    }
    
    function clearCurrentCell() {
      const cell = document.querySelector(`td[data-index="${currentCellIndex}"][data-field="rating"]`);
      if (cell) {
        cell.textContent = '';
        saveCell(currentCellIndex, 'rating', '');
        playBeep(600, 100);
      }
    }
          // ============================================
    // VOICE RECOGNITION
    // ============================================
    function startListening() {
      if (!currentTrial) {
        alert('Please load a trial first');
        return;
      }
      
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('Speech recognition is not supported in this browser. Please use Chrome, Edge, or Safari.');
        return;
      }
      
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = 'en-US';
      
      recognition.onstart = function() {
        isListening = true;
        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display = 'inline-block';
        document.getElementById('status').classList.add('listening');
        updateStatus('üé§ Listening... Speak now');
        playBeep(1000, 100);
      };
      
      recognition.onresult = function(event) {
        let interimTranscript = '';
        let finalTranscript = '';
        
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            finalTranscript += transcript;
          } else {
            interimTranscript += transcript;
          }
        }
        
        // Display interim results
        if (interimTranscript) {
          document.getElementById('transcriptDisplay').textContent = `Hearing: "${interimTranscript}"`;
        }
        
        // Process final results
        if (finalTranscript) {
          processVoiceCommand(finalTranscript.trim());
          document.getElementById('transcriptDisplay').textContent = '';
        }
      };
      
      recognition.onerror = function(event) {
        console.error('Speech recognition error:', event.error);
        if (event.error === 'no-speech') {
          updateStatus('No speech detected. Try again.');
        } else if (event.error === 'not-allowed') {
          alert('Microphone access denied. Please allow microphone access and try again.');
          stopListening();
        } else {
          updateStatus(`Error: ${event.error}`);
        }
      };
      
      recognition.onend = function() {
        if (isListening) {
          recognition.start(); // Auto-restart
        }
      };
      
      recognition.start();
    }
    
    function stopListening() {
      if (recognition) {
        isListening = false;
        recognition.stop();
        recognition = null;
      }
      
      document.getElementById('startBtn').style.display = 'inline-block';
      document.getElementById('stopBtn').style.display = 'none';
      document.getElementById('status').classList.remove('listening');
      updateStatus('Voice input stopped');
      document.getElementById('transcriptDisplay').textContent = '';
    }
    
    function processVoiceCommand(transcript) {
      const lowerTranscript = transcript.toLowerCase();
      
      // Navigation commands
      if (lowerTranscript.includes('next') || lowerTranscript.includes('skip')) {
        moveToNextCell();
        updateStatus(`Moved to plot ${currentCellIndex + 1}`);
        return;
      }
      
      if (lowerTranscript.includes('previous') || lowerTranscript.includes('back')) {
        moveToPreviousCell();
        updateStatus(`Moved to plot ${currentCellIndex + 1}`);
        return;
      }
      
      if (lowerTranscript.includes('clear')) {
        clearCurrentCell();
        updateStatus('Cell cleared');
        return;
      }
      
      if (lowerTranscript.includes('pause') || lowerTranscript.includes('stop')) {
        stopListening();
        return;
      }
      
      // Extract numbers from transcript
      const numbers = extractNumbers(transcript);
      
      if (numbers.length === 0) {
        updateStatus(`No valid numbers detected in: "${transcript}"`);
        return;
      }
      
      // Batch mode: process multiple numbers
      if (isBatchMode && numbers.length > 1) {
        processBatchNumbers(numbers);
      } else {
        // Single mode: use first number only
        processSingleNumber(numbers[0]);
      }
    }
    
    function extractNumbers(text) {
      const numbers = [];
      
      // Word to number mapping
      const wordToNum = {
        'zero': 0, 'one': 1, 'two': 2, 'three': 3, 'four': 4,
        'five': 5, 'six': 6, 'seven': 7, 'eight': 8, 'nine': 9,
        'ten': 10, 'eleven': 11, 'twelve': 12, 'thirteen': 13, 'fourteen': 14,
        'fifteen': 15, 'sixteen': 16, 'seventeen': 17, 'eighteen': 18, 'nineteen': 19,
        'twenty': 20, 'twenty-five': 25, 'thirty': 30, 'thirty-five': 35,
        'forty': 40, 'forty-five': 45, 'fifty': 50, 'fifty-five': 55,
        'sixty': 60, 'sixty-five': 65, 'seventy': 70, 'seventy-five': 75,
        'eighty': 80, 'eighty-five': 85, 'ninety': 90, 'ninety-five': 95,
        'hundred': 100
      };
      
      // Split by common delimiters
      const parts = text.toLowerCase().split(/[,\s]+/);
      
      for (const part of parts) {
        // Check if it's a digit
        const numMatch = part.match(/\d+/);
        if (numMatch) {
          const num = parseInt(numMatch[0]);
          if (isValidNumber(num)) {
            numbers.push(num);
          }
          continue;
        }
        
        // Check if it's a word number
        if (wordToNum.hasOwnProperty(part)) {
          const num = wordToNum[part];
          if (isValidNumber(num)) {
            numbers.push(num);
          }
        }
      }
      
      return numbers;
    }
    
    function isValidNumber(num) {
      if (num < 0 || num > 100) return false;
      
      if (multiplesOf5Only) {
        return num % 5 === 0;
      }
      
      return true;
    }
    
    function processSingleNumber(number) {
      const cell = document.querySelector(`td[data-index="${currentCellIndex}"][data-field="rating"]`);
      if (cell) {
        cell.textContent = number;
        saveCell(currentCellIndex, 'rating', number.toString());
        playBeep(1100, 120);
        updateStatus(`‚úì Recorded ${number} for plot ${currentCellIndex + 1}`);
        
        // Auto-advance
        setTimeout(() => {
          moveToNextCell();
        }, 300);
      }
    }
    
    function processBatchNumbers(numbers) {
      let recordedCount = 0;
      let startIndex = currentCellIndex;
      
      for (let i = 0; i < numbers.length; i++) {
        if (currentCellIndex >= currentTrial.data.length) {
          break;
        }
        
        const cell = document.querySelector(`td[data-index="${currentCellIndex}"][data-field="rating"]`);
        if (cell) {
          cell.textContent = numbers[i];
          saveCell(currentCellIndex, 'rating', numbers[i].toString());
          recordedCount++;
          
          if (i < numbers.length - 1) {
            moveToNextCell();
          }
        }
      }
      
      playBeep(1200, 150);
      updateStatus(`‚úì Batch recorded ${recordedCount} values: ${numbers.join(', ')}`);
      
      // Move to next cell after batch
      setTimeout(() => {
        moveToNextCell();
      }, 500);
    }
    
    function updateStatus(message) {
      document.getElementById('statusText').textContent = message;
    }
    
    // ============================================
    // SETTINGS
    // ============================================
    function toggleBatchMode() {
      isBatchMode = document.getElementById('batchModeToggle').checked;
      const modeIndicator = document.getElementById('modeIndicator');
      const modeText = document.getElementById('modeText');
      
      if (isBatchMode) {
        modeIndicator.className = 'mode-indicator mode-batch';
        modeText.textContent = 'Batch Mode (Multiple Numbers)';
      } else {
        modeIndicator.className = 'mode-indicator mode-single';
        modeText.textContent = 'Single Cell Mode';
      }
    }
    
    function toggleMultiplesOf5() {
      multiplesOf5Only = document.getElementById('multiplesOf5Toggle').checked;
      updateAcceptedNumbersDisplay();
    }
    
    function updateAcceptedNumbersDisplay() {
      const display = document.getElementById('acceptedNumbers');
      if (multiplesOf5Only) {
        display.textContent = 'Multiples of 5 only (0, 5, 10, 15, 20, 25...)';
      } else {
        display.textContent = 'All numbers (0-100)';
      }
    }
    
    function toggleLegend() {
      document.getElementById('legend').classList.toggle('active');
    }
    
    // ============================================
    // EXPORT
    // ============================================
    function exportToCSV() {
      if (!currentTrial) {
        alert('No trial loaded');
        return;
      }
      
      let csv = 'Plot,Rating,Notes\n';
      
      currentTrial.data.forEach(row => {
        csv += `${row.plot},"${row.rating}","${row.notes}"\n`;
      });
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${currentTrial.code}_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      
      playBeep(1300, 200);
      updateStatus('‚úì CSV exported successfully!');
    }
  </script>
</body>
</html>
