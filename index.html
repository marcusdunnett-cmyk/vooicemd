<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Syngenta Trial Data Entry</title>
    <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .content {
      padding: 40px;
    }

    .form-group {
      margin-bottom: 25px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
      font-size: 16px;
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      padding: 12px 30px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
      margin-left: 10px;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .btn-success {
      background: #28a745;
      color: white;
      margin-left: 10px;
    }

    .btn-success:hover {
      background: #218838;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
      margin-left: 10px;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .table-container {
      overflow-x: auto;
      margin-top: 30px;
      border: 2px solid #ddd;
      border-radius: 8px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    td {
      padding: 12px 15px;
      border: 1px solid #ddd;
      min-width: 100px;
    }

    td[contenteditable="true"] {
      cursor: text;
      background: #f8f9fa;
    }

    td[contenteditable="true"]:hover {
      background: #e9ecef;
    }

    td[contenteditable="true"]:focus {
      outline: 2px solid #667eea;
      background: #fff;
    }

    .cell-highlight {
      background: #fff3cd !important;
      outline: 3px solid #ffc107 !important;
    }

    .controls {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .assessment-manager {
      margin-top: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .assessment-manager h3 {
      margin-bottom: 15px;
      color: #333;
    }

    .assessment-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }

    .assessment-tag {
      background: #667eea;
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .assessment-tag button {
      background: rgba(255,255,255,0.3);
      border: none;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      cursor: pointer;
      font-size: 12px;
    }

    .assessment-tag button:hover {
      background: rgba(255,255,255,0.5);
    }

    #setupScreen, #dataEntryScreen {
      display: none;
    }

    .trial-selector {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .trial-selector h3 {
      margin-bottom: 15px;
      color: #333;
    }

    .trial-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .trial-card {
      background: white;
      padding: 15px 20px;
      border-radius: 8px;
      border: 2px solid #ddd;
      cursor: pointer;
      transition: all 0.3s;
    }

    .trial-card:hover {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    .trial-card.active {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .voice-controls {
      margin-top: 20px;
      padding: 20px;
      background: #f0f4ff;
      border-radius: 8px;
      border: 2px solid #667eea;
    }

    .voice-status {
      padding: 15px;
      background: white;
      border-radius: 8px;
      margin-top: 15px;
      font-size: 18px;
      text-align: center;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .mode-toggle {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      align-items: center;
    }

    .mode-toggle label {
      font-weight: 600;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üåæ Syngenta Trial Data Entry</h1>
      <p>Professional Field Trial Management System</p>
    </div>

    <div class="content">
      <!-- Trial Selection Screen -->
      <div id="trialSelectionScreen">
        <div class="trial-selector">
          <h3>Select Existing Trial</h3>
          <div class="trial-list" id="trialList"></div>
        </div>
        <button class="btn btn-primary" onclick="showSetupScreen()" style="font-size: 18px; padding: 15px 40px;">
          ‚ûï Create New Trial
        </button>
      </div>

      <!-- Setup Screen -->
      <div id="setupScreen">
        <h2 style="margin-bottom: 30px; color: #333;">Create New Trial</h2>
        
        <div class="form-group">
          <label for="code">Trial Code</label>
          <input type="text" id="code" placeholder="e.g., TRIAL-2024-001">
        </div>

        <div class="form-group">
          <label for="treatments">Number of Treatments</label>
          <input type="number" id="treatments" min="1" value="4">
        </div>

        <div class="form-group">
          <label for="reps">Number of Replications</label>
          <input type="number" id="reps" min="1" value="3">
        </div>

        <div class="form-group">
          <label for="subplots">Number of Subplots per Rep</label>
          <input type="number" id="subplots" min="1" value="2">
        </div>

        <button class="btn btn-primary" onclick="createTrial()" style="font-size: 18px; padding: 15px 40px;">
          Create Trial
        </button>
        <button class="btn btn-secondary" onclick="backToSelection()">
          Cancel
        </button>
      </div>

      <!-- Data Entry Screen -->
      <div id="dataEntryScreen">
        <h2 id="trialTitle" style="margin-bottom: 20px; color: #333;"></h2>

        <div class="assessment-manager">
          <h3>Assessment Columns</h3>
          <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <input type="text" id="newAssessment" placeholder="e.g., Plant Height" style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
            <button class="btn btn-primary" onclick="addAssessment()">Add Column</button>
          </div>
          <div class="assessment-list" id="assessmentList"></div>
        </div>

        <!-- Voice Recording Controls -->
        <div class="voice-controls">
          <h3>üé§ Voice Recording</h3>
          
          <div class="mode-toggle">
            <label>Recording Mode:</label>
            <button class="btn btn-primary" id="oneAtATimeBtn" onclick="setRecordingMode('oneAtATime')">
              One-at-a-Time
            </button>
            <button class="btn btn-secondary" id="batchBtn" onclick="setRecordingMode('batch')">
              Batch Mode
            </button>
          </div>

          <div style="margin-top: 15px;">
            <button class="btn btn-success" id="startVoiceBtn" onclick="startVoiceRecording()">
              üé§ Start Recording
            </button>
            <button class="btn btn-danger" id="pauseVoiceBtn" onclick="pauseVoiceRecording()" style="display: none;">
              ‚è∏Ô∏è Pause
            </button>
            <button class="btn btn-secondary" id="stopVoiceBtn" onclick="stopVoiceRecording()" style="display: none;">
              ‚èπÔ∏è Stop
            </button>
          </div>

          <div class="voice-status" id="voiceStatus">
            Ready to record
          </div>
        </div>

        <div class="table-container">
          <table>
            <thead id="tableHeader"></thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>

        <div class="controls">
          <button class="btn btn-success" onclick="exportToCSV()">üì• Export to CSV</button>
          <button class="btn btn-secondary" onclick="backToSelection()">üîô Back to Trials</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    let currentTrial = null;
    let trials = JSON.parse(localStorage.getItem('trials')) || [];
    let isRecording = false;
    let isPaused = false;
    let recognition = null;
    let currentCell = null;
    let recordingMode = 'oneAtATime';

    const wordToNumber = {
      'zero': '0', 'one': '1', 'two': '2', 'three': '3', 'four': '4',
      'five': '5', 'six': '6', 'seven': '7', 'eight': '8', 'nine': '9',
      'ten': '10', 'eleven': '11', 'twelve': '12', 'thirteen': '13',
      'fourteen': '14', 'fifteen': '15', 'sixteen': '16', 'seventeen': '17',
      'eighteen': '18', 'nineteen': '19', 'twenty': '20', 'thirty': '30',
      'forty': '40', 'fifty': '50', 'sixty': '60', 'seventy': '70',
      'eighty': '80', 'ninety': '90', 'hundred': '100'
    };

    function convertWordToNumber(text) {
      const lowerText = text.toLowerCase().trim();
      
      if (!isNaN(lowerText)) {
        return lowerText;
      }
      
      if (wordToNumber[lowerText]) {
        return wordToNumber[lowerText];
      }
      
      const words = lowerText.split(/[\s-]+/);
      if (words.length === 2) {
        const tens = wordToNumber[words[0]];
        const ones = wordToNumber[words[1]];
        if (tens && ones && parseInt(tens) >= 20 && parseInt(ones) < 10) {
          return String(parseInt(tens) + parseInt(ones));
        }
      }
      
      return text;
    }

    window.onload = function() {
      loadTrials();
      setupVoiceRecognition();
    };

    function setupVoiceRecognition() {
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = false;
        recognition.lang = 'en-US';

        recognition.onresult = function(event) {
          const last = event.results.length - 1;
          const text = event.results[last][0].transcript.trim();
          
          document.getElementById('voiceStatus').innerHTML = `Heard: "${text}"`;
          
          if (!currentCell || isPaused) return;
          
          // Split by commas for batch entry
          const values = text.split(',').map(v => v.trim()).filter(v => v);
          
          if (recordingMode === 'batch') {
            // In batch mode, split values go to consecutive cells
            let cell = currentCell;
            values.forEach((value, index) => {
              if (cell) {
                const convertedValue = convertWordToNumber(value);
                cell.textContent = convertedValue;
                
                // Move to next cell for subsequent values
                if (index < values.length - 1) {
                  const allCells = Array.from(document.querySelectorAll('td[contenteditable="true"]'));
                  const currentIndex = allCells.indexOf(cell);
                  if (currentIndex < allCells.length - 1) {
                    cell = allCells[currentIndex + 1];
                  }
                }
              }
            });
            
            // Update currentCell to last filled cell
            currentCell = cell;
            highlightCell(currentCell);
            saveCurrentTrial();
            
          } else {
            // One-at-a-time mode: only use first value, ignore rest
            const convertedValue = convertWordToNumber(values[0]);
            currentCell.textContent = convertedValue;
            saveCurrentTrial();
            moveToNextCell();
          }
        };

        recognition.onerror = function(event) {
          console.error('Speech recognition error:', event.error);
          document.getElementById('voiceStatus').innerHTML = `Error: ${event.error}`;
        };

        recognition.onend = function() {
          if (isRecording && !isPaused) {
            recognition.start();
          }
        };
      } else {
        alert('Speech recognition not supported in this browser. Please use Chrome or Edge.');
      }
    }

    function setRecordingMode(mode) {
      recordingMode = mode;
      
      const oneBtn = document.getElementById('oneAtATimeBtn');
      const batchBtn = document.getElementById('batchBtn');
      
      if (mode === 'oneAtATime') {
        oneBtn.className = 'btn btn-primary';
        batchBtn.className = 'btn btn-secondary';
      } else {
        oneBtn.className = 'btn btn-secondary';
        batchBtn.className = 'btn btn-primary';
      }
    }

    function startVoiceRecording() {
      if (!recognition) {
        alert('Speech recognition not available');
        return;
      }

      isRecording = true;
      isPaused = false;
      
      if (!currentCell) {
        const firstCell = document.querySelector('td[contenteditable="true"]');
        if (firstCell) {
          currentCell = firstCell;
          highlightCell(currentCell);
        }
      } else {
        highlightCell(currentCell);
      }

      recognition.start();
      
      document.getElementById('startVoiceBtn').style.display = 'none';
      document.getElementById('pauseVoiceBtn').style.display = 'inline-block';
      document.getElementById('stopVoiceBtn').style.display = 'inline-block';
      document.getElementById('voiceStatus').innerHTML = 'üé§ Listening...';
    }

    function pauseVoiceRecording() {
      isPaused = true;
      recognition.stop();
      
      document.getElementById('pauseVoiceBtn').style.display = 'none';
      document.getElementById('startVoiceBtn').style.display = 'inline-block';
      document.getElementById('voiceStatus').innerHTML = '‚è∏Ô∏è Paused - Tap a cell to select, then hit Start to resume';
    }

    function stopVoiceRecording() {
      isRecording = false;
      isPaused = false;
      recognition.stop();
      
      if (currentCell) {
        currentCell.classList.remove('cell-highlight');
        currentCell = null;
      }
      
      document.getElementById('startVoiceBtn').style.display = 'inline-block';
      document.getElementById('pauseVoiceBtn').style.display = 'none';
      document.getElementById('stopVoiceBtn').style.display = 'none';
      document.getElementById('voiceStatus').innerHTML = 'Ready to record';
    }

    function highlightCell(cell) {
      document.querySelectorAll('td').forEach(td => td.classList.remove('cell-highlight'));
      if (cell) {
        cell.classList.add('cell-highlight');
      }
    }

    function moveToNextCell() {
      if (!currentCell) return;

      const allCells = Array.from(document.querySelectorAll('td[contenteditable="true"]'));
      const currentIndex = allCells.indexOf(currentCell);
      
      if (currentIndex < allCells.length - 1) {
        currentCell = allCells[currentIndex + 1];
        highlightCell(currentCell);
      } else {
        stopVoiceRecording();
        alert('Reached end of data entry');
      }
    }

    document.addEventListener('click', function(e) {
      if (e.target.tagName === 'TD' && e.target.hasAttribute('contenteditable')) {
        if (isRecording || isPaused) {
          currentCell = e.target;
          highlightCell(currentCell);
        }
      }
    });

    function loadTrials() {
      const trialList = document.getElementById('trialList');
      trialList.innerHTML = '';

      if (trials.length === 0) {
        trialList.innerHTML = '<p style="color: #666;">No trials yet. Create your first trial!</p>';
        return;
      }

      trials.forEach((trial, index) => {
        const card = document.createElement('div');
        card.className = 'trial-card';
        card.innerHTML = `
          <strong>${trial.code}</strong><br>
          <small>${trial.treatments} treatments √ó ${trial.reps} reps √ó ${trial.subplots} subplots</small>
        `;
        card.onclick = () => loadTrial(index);
        trialList.appendChild(card);
      });
    }

    function showSetupScreen() {
      document.getElementById('trialSelectionScreen').style.display = 'none';
      document.getElementById('setupScreen').style.display = 'block';
    }

    function backToSelection() {
      document.getElementById('setupScreen').style.display = 'none';
      document.getElementById('dataEntryScreen').style.display = 'none';
      document.getElementById('trialSelectionScreen').style.display = 'block';
      currentTrial = null;
      stopVoiceRecording();
      loadTrials();
    }

    function createTrial() {
      const code = document.getElementById('code').value.trim();
      const treatments = parseInt(document.getElementById('treatments').value);
      const reps = parseInt(document.getElementById('reps').value);
      const subplots = parseInt(document.getElementById('subplots').value);

      if (!code) {
        alert('Please enter a trial code');
        return;
      }

      const trial = {
        code: code,
        treatments: treatments,
        reps: reps,
        subplots: subplots,
        assessments: [],
        data: []
      };

      for (let t = 1; t <= treatments; t++) {
        for (let r = 1; r <= reps; r++) {
          for (let s = 1; s <= subplots; s++) {
            trial.data.push({
              treatment: t,
              rep: r,
              subplot: s,
              values: {}
            });
          }
        }
      }

      trials.push(trial);
      localStorage.setItem('trials', JSON.stringify(trials));
      
      loadTrial(trials.length - 1);
    }

    function loadTrial(index) {
      currentTrial = index;
      const trial = trials[index];

      document.getElementById('trialSelectionScreen').style.display = 'none';
      document.getElementById('setupScreen').style.display = 'none';
      document.getElementById('dataEntryScreen').style.display = 'block';

      document.getElementById('trialTitle').textContent = `Trial: ${trial.code}`;

      renderAssessments();
      renderTable();
    }

    function renderAssessments() {
      const trial = trials[currentTrial];
      const list = document.getElementById('assessmentList');
      list.innerHTML = '';

      trial.assessments.forEach((assessment, index) => {
        const tag = document.createElement('div');
        tag.className = 'assessment-tag';
        tag.innerHTML = `
          ${assessment}
          <button onclick="removeAssessment(${index})">√ó</button>
        `;
        list.appendChild(tag);
      });
    }

    function addAssessment() {
      const input = document.getElementById('newAssessment');
      const name = input.value.trim();

      if (!name) {
        alert('Please enter an assessment name');
        return;
      }

      const trial = trials[currentTrial];
      trial.assessments.push(name);
      
      trial.data.forEach(row => {
        row.values[name] = '';
      });

      saveCurrentTrial();
      renderAssessments();
      renderTable();
      
      input.value = '';
    }

    function removeAssessment(index) {
      if (!confirm('Remove this assessment column?')) return;

      const trial = trials[currentTrial];
      const assessmentName = trial.assessments[index];
      
      trial.assessments.splice(index, 1);
      
      trial.data.forEach(row => {
        delete row.values[assess
              function removeAssessment(index) {
      if (!confirm('Remove this assessment column?')) return;

      const trial = trials[currentTrial];
      const assessmentName = trial.assessments[index];
      
      trial.assessments.splice(index, 1);
      
      trial.data.forEach(row => {
        delete row.values[assessmentName];
      });

      saveCurrentTrial();
      renderAssessments();
      renderTable();
    }

    function renderTable() {
      const trial = trials[currentTrial];
      const header = document.getElementById('tableHeader');
      const body = document.getElementById('tableBody');

      let headerHTML = '<tr><th>Treatment</th><th>Rep</th><th>Subplot</th>';
      trial.assessments.forEach(assessment => {
        headerHTML += `<th>${assessment}</th>`;
      });
      headerHTML += '</tr>';
      header.innerHTML = headerHTML;

      body.innerHTML = '';
      trial.data.forEach((row, rowIndex) => {
        const tr = document.createElement('tr');
        
        tr.innerHTML = `
          <td>${row.treatment}</td>
          <td>${row.rep}</td>
          <td>${row.subplot}</td>
        `;

        trial.assessments.forEach(assessment => {
          const td = document.createElement('td');
          td.contentEditable = true;
          td.textContent = row.values[assessment] || '';
          td.addEventListener('blur', function() {
            row.values[assessment] = this.textContent.trim();
            saveCurrentTrial();
          });
          tr.appendChild(td);
        });

        body.appendChild(tr);
      });
    }

    function saveCurrentTrial() {
      localStorage.setItem('trials', JSON.stringify(trials));
    }

    function exportToCSV() {
      const trial = trials[currentTrial];
      
      let csv = 'Treatment,Rep,Subplot,' + trial.assessments.join(',') + '\n';
      
      trial.data.forEach(row => {
        let rowData = [row.treatment, row.rep, row.subplot];
        trial.assessments.forEach(assessment => {
          rowData.push(row.values[assessment] || '');
        });
        csv += rowData.join(',') + '\n';
      });

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${trial.code}_data.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
